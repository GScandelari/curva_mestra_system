/**
 * Script r√°pido para upgrade usando Firebase CLI
 */

const { execSync } = require('child_process');
const fs = require('fs');

console.log('üöÄ UPGRADE R√ÅPIDO PARA ADMIN');
console.log('üë§ Email: scandelari.guilherme@hotmail.com');
console.log('üÜî UID: 0vdFsTyia3di70080j9KG1vccLN2');

try {
  // Criar script Node.js simples que ser√° executado
  const upgradeScript = `
const admin = require('firebase-admin');

// Tentar inicializar com diferentes m√©todos
let app;
try {
  app = admin.initializeApp({
    projectId: 'curva-mestra'
  });
} catch (e) {
  console.log('Tentando m√©todo alternativo...');
  try {
    app = admin.initializeApp();
  } catch (e2) {
    console.error('Erro na inicializa√ß√£o:', e2.message);
    process.exit(1);
  }
}

const targetUid = '0vdFsTyia3di70080j9KG1vccLN2';
const adminClaims = {
  role: 'admin',
  isAdmin: true,
  clinicId: 'default-clinic',
  permissions: [
    'view_products', 'manage_products', 'view_requests', 'approve_requests',
    'view_patients', 'manage_patients', 'view_invoices', 'manage_invoices',
    'view_reports', 'manage_users', 'view_analytics', 'manage_settings'
  ]
};

console.log('üîß Aplicando custom claims...');

admin.auth().setCustomUserClaims(targetUid, adminClaims)
  .then(() => {
    console.log('‚úÖ Custom claims aplicados!');
    return admin.auth().getUser(targetUid);
  })
  .then(user => {
    console.log('üéâ UPGRADE REALIZADO COM SUCESSO!');
    console.log('üìß Email:', user.email);
    console.log('üîë Role:', user.customClaims?.role);
    console.log('üëë Is Admin:', user.customClaims?.isAdmin);
    console.log('üè• Clinic ID:', user.customClaims?.clinicId);
    console.log('üìä Permiss√µes:', user.customClaims?.permissions?.length || 0);
    console.log('');
    console.log('üîÑ PR√ìXIMOS PASSOS:');
    console.log('1. üö™ Fa√ßa LOGOUT do sistema');
    console.log('2. üîë Fa√ßa LOGIN novamente');
    console.log('3. üåê Acesse: https://curva-mestra.web.app');
    console.log('4. ‚úÖ Verifique acesso de Admin!');
    process.exit(0);
  })
  .catch(error => {
    console.error('‚ùå Erro:', error.message);
    
    if (error.message.includes('credentials')) {
      console.log('');
      console.log('üîë PROBLEMA DE CREDENCIAIS');
      console.log('üìã SOLU√á√ïES:');
      console.log('');
      console.log('1Ô∏è‚É£ GOOGLE CLOUD CLI:');
      console.log('   - Instale: https://cloud.google.com/sdk/docs/install-windows');
      console.log('   - Execute: gcloud auth application-default login');
      console.log('   - Execute: node quick-admin-upgrade.js');
      console.log('');
      console.log('2Ô∏è‚É£ SERVICE ACCOUNT:');
      console.log('   - Acesse: https://console.cloud.google.com/iam-admin/serviceaccounts?project=curva-mestra');
      console.log('   - Baixe a chave JSON do Firebase Admin SDK');
      console.log('   - set GOOGLE_APPLICATION_CREDENTIALS=caminho\\\\para\\\\chave.json');
      console.log('   - node quick-admin-upgrade.js');
      console.log('');
      console.log('3Ô∏è‚É£ MANUAL (MAIS R√ÅPIDO):');
      console.log('   - Acesse: https://console.firebase.google.com/project/curva-mestra');
      console.log('   - Authentication ‚Üí Users ‚Üí scandelari.guilherme@hotmail.com');
      console.log('   - Se n√£o houver "Custom Claims", use uma das op√ß√µes acima');
    }
    
    process.exit(1);
  });
`;

  // Escrever script tempor√°rio
  fs.writeFileSync('temp-quick-upgrade.js', upgradeScript);
  console.log('‚úÖ Script tempor√°rio criado');

  // Tentar executar no contexto das functions
  console.log('üîß Tentando executar no contexto das functions...');
  
  try {
    execSync('node temp-quick-upgrade.js', { 
      stdio: 'inherit',
      cwd: './functions'
    });
  } catch (error) {
    console.log('‚ö†Ô∏è Tentativa no diret√≥rio functions falhou');
    console.log('üîß Tentando no diret√≥rio root...');
    
    execSync('node temp-quick-upgrade.js', { 
      stdio: 'inherit',
      cwd: '.'
    });
  }

} catch (error) {
  console.error('‚ùå Erro no processo:', error.message);
  
  console.log('\\nüìã INSTRU√á√ïES MANUAIS R√ÅPIDAS:');
  console.log('\\nüéØ OP√á√ÉO MAIS R√ÅPIDA - MANUAL:');
  console.log('1. Acesse: https://console.firebase.google.com/project/curva-mestra');
  console.log('2. Authentication ‚Üí Users');
  console.log('3. Encontre: scandelari.guilherme@hotmail.com');
  console.log('4. Clique no usu√°rio');
  console.log('5. Se houver "Custom Claims", adicione:');
  console.log(JSON.stringify({
    role: 'admin',
    isAdmin: true,
    clinicId: 'default-clinic',
    permissions: [
      'view_products', 'manage_products', 'view_requests', 'approve_requests',
      'view_patients', 'manage_patients', 'view_invoices', 'manage_invoices',
      'view_reports', 'manage_users', 'view_analytics', 'manage_settings'
    ]
  }, null, 2));
  console.log('6. Save ‚Üí Logout/Login no sistema');
  
} finally {
  // Limpar arquivo tempor√°rio
  if (fs.existsSync('temp-quick-upgrade.js')) {
    fs.unlinkSync('temp-quick-upgrade.js');
  }
}