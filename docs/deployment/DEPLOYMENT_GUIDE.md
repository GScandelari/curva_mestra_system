# Guia de Deploy e Rollback - Plataforma Curva Mestra

## Vis√£o Geral

Este guia fornece instru√ß√µes detalhadas para deploy e rollback da plataforma Curva Mestra, incluindo procedimentos automatizados e manuais para diferentes ambientes.

## Arquitetura de Deploy

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Desenvolvimento  ‚îÇ    ‚îÇ    Staging      ‚îÇ    ‚îÇ    Produ√ß√£o     ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Local         ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ Firebase      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ Firebase      ‚îÇ
‚îÇ ‚Ä¢ Hot Reload    ‚îÇ    ‚îÇ ‚Ä¢ Preview       ‚îÇ    ‚îÇ ‚Ä¢ Live          ‚îÇ
‚îÇ ‚Ä¢ Debug Mode    ‚îÇ    ‚îÇ ‚Ä¢ Testing       ‚îÇ    ‚îÇ ‚Ä¢ Monitoring    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Pr√©-requisitos

### Ferramentas Necess√°rias
```bash
# Node.js (vers√£o 18+)
node --version

# npm (vers√£o 8+)
npm --version

# Firebase CLI
npm install -g firebase-tools
firebase --version

# Git
git --version
```

### Configura√ß√£o Inicial
```bash
# 1. Clonar reposit√≥rio
git clone https://github.com/seu-usuario/curva-mestra.git
cd curva-mestra

# 2. Instalar depend√™ncias
npm install
cd frontend && npm install
cd ../backend && npm install
cd ../functions && npm install

# 3. Configurar Firebase
firebase login
firebase use --add

# 4. Configurar vari√°veis de ambiente
cp .env.example .env
# Editar .env com suas configura√ß√µes
```

## Deploy Automatizado

### 1. Pipeline de Deploy Completo

#### Script Principal
```bash
#!/bin/bash
# scripts/deploy.sh

set -e  # Parar em caso de erro

echo "üöÄ Iniciando deploy completo..."

# Valida√ß√µes pr√©-deploy
echo "üîç Executando valida√ß√µes..."
npm run validate:all

# Build de todos os componentes
echo "üî® Construindo aplica√ß√£o..."
npm run build:all

# Testes finais
echo "üß™ Executando testes..."
npm run test:production

# Deploy para Firebase
echo "üì§ Fazendo deploy para Firebase..."
firebase deploy

echo "‚úÖ Deploy conclu√≠do com sucesso!"
```

#### Comandos npm
```json
{
  "scripts": {
    "deploy": "bash scripts/deploy.sh",
    "deploy:frontend": "firebase deploy --only hosting",
    "deploy:backend": "firebase deploy --only functions",
    "deploy:rules": "firebase deploy --only firestore:rules,storage",
    "validate:all": "npm run validate:config && npm run validate:build",
    "validate:config": "node scripts/validateEnvironment.js",
    "validate:build": "npm run build && npm run test:build",
    "build:all": "npm run build:frontend && npm run build:backend",
    "build:frontend": "cd frontend && npm run build",
    "build:backend": "cd backend && npm run build",
    "test:production": "npm run test:frontend && npm run test:backend"
  }
}
```

### 2. Deploy por Componente

#### Frontend (Firebase Hosting)
```bash
# Build e deploy do frontend
cd frontend
npm run build
firebase deploy --only hosting

# Deploy com preview
firebase hosting:channel:deploy preview-$(date +%Y%m%d)
```

#### Backend (Firebase Functions)
```bash
# Deploy de todas as functions
firebase deploy --only functions

# Deploy de function espec√≠fica
firebase deploy --only functions:api

# Deploy com configura√ß√£o de runtime
firebase functions:config:set app.environment=production
firebase deploy --only functions
```

#### Regras de Seguran√ßa
```bash
# Deploy das regras Firestore
firebase deploy --only firestore:rules

# Deploy das regras Storage
firebase deploy --only storage

# Deploy de todas as regras
firebase deploy --only firestore:rules,storage
```

### 3. Deploy com Valida√ß√£o

#### Pipeline com Valida√ß√£o Autom√°tica
```javascript
// scripts/deployPipeline.js
const { DeploymentPipeline } = require('../shared/utils/DeploymentPipeline');

async function runDeployPipeline() {
  const pipeline = new DeploymentPipeline();
  
  try {
    // 1. Valida√ß√£o pr√©-deploy
    console.log('üîç Validando configura√ß√µes...');
    const validation = await pipeline.validateChanges();
    if (!validation.success) {
      throw new Error(`Valida√ß√£o falhou: ${validation.errors.join(', ')}`);
    }
    
    // 2. Build
    console.log('üî® Construindo aplica√ß√£o...');
    await pipeline.buildAll();
    
    // 3. Testes
    console.log('üß™ Executando testes...');
    await pipeline.runTests();
    
    // 4. Deploy
    console.log('üì§ Fazendo deploy...');
    const result = await pipeline.deployAll();
    
    if (result.success) {
      console.log('‚úÖ Deploy conclu√≠do com sucesso!');
      console.log(`üìã Vers√£o: ${result.version}`);
    } else {
      throw new Error(`Deploy falhou: ${result.errors.join(', ')}`);
    }
    
  } catch (error) {
    console.error('‚ùå Erro no deploy:', error.message);
    
    // Rollback autom√°tico em caso de falha
    console.log('üîÑ Iniciando rollback...');
    await pipeline.rollback();
    
    process.exit(1);
  }
}

runDeployPipeline();
```

## Deploy Manual

### 1. Processo Passo-a-Passo

#### Prepara√ß√£o
```bash
# 1. Verificar branch
git branch
git status

# 2. Atualizar c√≥digo
git pull origin main

# 3. Verificar configura√ß√µes
node scripts/validateEnvironment.js --production

# 4. Limpar cache
npm run clean
```

#### Build
```bash
# 1. Instalar depend√™ncias atualizadas
npm ci
cd frontend && npm ci
cd ../backend && npm ci
cd ../functions && npm ci

# 2. Build frontend
cd frontend
npm run build
cd ..

# 3. Build backend (se necess√°rio)
cd backend
npm run build
cd ..

# 4. Verificar builds
ls -la frontend/dist/
ls -la backend/dist/
```

#### Deploy
```bash
# 1. Deploy frontend
firebase deploy --only hosting

# 2. Deploy functions
firebase deploy --only functions

# 3. Deploy regras (se alteradas)
firebase deploy --only firestore:rules,storage

# 4. Verificar deploy
firebase hosting:releases:list --limit=5
```

### 2. Deploy de Emerg√™ncia

#### Procedimento R√°pido
```bash
#!/bin/bash
# scripts/emergency-deploy.sh

echo "üö® DEPLOY DE EMERG√äNCIA"
echo "Pulando valida√ß√µes n√£o-cr√≠ticas..."

# Build r√°pido
npm run build:frontend --production
firebase deploy --only hosting

# Verificar se deploy funcionou
curl -f https://seu-dominio.com/health || {
  echo "‚ùå Deploy falhou, iniciando rollback..."
  firebase hosting:clone SOURCE_SITE_ID:VERSION_ID TARGET_SITE_ID
  exit 1
}

echo "‚úÖ Deploy de emerg√™ncia conclu√≠do"
```

## Rollback

### 1. Rollback Autom√°tico

#### Sistema de Rollback
```javascript
// scripts/rollback.js
const { RollbackManager } = require('../shared/utils/RollbackManager');

async function performRollback(targetVersion = null) {
  const rollback = new RollbackManager();
  
  try {
    // Listar vers√µes dispon√≠veis
    const versions = await rollback.listAvailableVersions();
    console.log('üìã Vers√µes dispon√≠veis:', versions);
    
    // Determinar vers√£o alvo
    const target = targetVersion || versions.find(v => v.stable);
    if (!target) {
      throw new Error('Nenhuma vers√£o est√°vel encontrada');
    }
    
    console.log(`üîÑ Fazendo rollback para vers√£o: ${target.version}`);
    
    // Executar rollback
    const result = await rollback.rollbackTo(target.version);
    
    if (result.success) {
      console.log('‚úÖ Rollback conclu√≠do com sucesso!');
      
      // Validar rollback
      await rollback.validateRollback();
      
    } else {
      throw new Error(`Rollback falhou: ${result.error}`);
    }
    
  } catch (error) {
    console.error('‚ùå Erro no rollback:', error.message);
    process.exit(1);
  }
}

// CLI
const targetVersion = process.argv[2];
performRollback(targetVersion);
```

### 2. Rollback Manual

#### Firebase Hosting
```bash
# 1. Listar releases
firebase hosting:releases:list --limit=10

# 2. Clonar release anterior
firebase hosting:clone SOURCE_SITE_ID:VERSION_ID TARGET_SITE_ID

# 3. Verificar rollback
curl -f https://seu-dominio.com/
```

#### Firebase Functions
```bash
# 1. Listar vers√µes das functions
gcloud functions list

# 2. Fazer rollback de function espec√≠fica
gcloud functions deploy FUNCTION_NAME --source=./previous-version/

# 3. Verificar function
gcloud functions describe FUNCTION_NAME
```

### 3. Rollback de Emerg√™ncia

#### Procedimento Cr√≠tico
```bash
#!/bin/bash
# scripts/emergency-rollback.sh

echo "üö® ROLLBACK DE EMERG√äNCIA"

# Rollback imediato do hosting
LAST_STABLE=$(firebase hosting:releases:list --limit=5 | grep "FINALIZED" | head -1 | awk '{print $1}')
firebase hosting:clone $LAST_STABLE

# Rollback das functions cr√≠ticas
firebase deploy --only functions:api,functions:auth --source=./backup/stable/

# Verificar sistema
node scripts/systemStatus.js --critical

echo "‚úÖ Rollback de emerg√™ncia conclu√≠do"
```

## Ambientes de Deploy

### 1. Desenvolvimento
```bash
# Configura√ß√£o local
npm run dev

# Deploy para ambiente de desenvolvimento
firebase use dev-project
firebase deploy
```

### 2. Staging
```bash
# Deploy para staging
firebase use staging-project
npm run build:staging
firebase deploy

# Testes em staging
npm run test:staging
```

### 3. Produ√ß√£o
```bash
# Deploy para produ√ß√£o
firebase use production-project
npm run build:production
firebase deploy --only hosting,functions

# Monitoramento p√≥s-deploy
npm run monitor:production
```

## Monitoramento de Deploy

### 1. Valida√ß√£o P√≥s-Deploy

#### Health Checks
```javascript
// scripts/post-deploy-validation.js
const { PostDeployValidator } = require('../shared/utils/PostDeployValidator');

async function validateDeploy() {
  const validator = new PostDeployValidator();
  
  const checks = [
    'frontend-accessibility',
    'api-endpoints',
    'authentication',
    'database-connectivity',
    'performance-metrics'
  ];
  
  for (const check of checks) {
    console.log(`üîç Executando: ${check}`);
    const result = await validator.runCheck(check);
    
    if (result.success) {
      console.log(`‚úÖ ${check}: OK`);
    } else {
      console.error(`‚ùå ${check}: FALHA - ${result.error}`);
      return false;
    }
  }
  
  console.log('‚úÖ Todas as valida√ß√µes passaram!');
  return true;
}

validateDeploy();
```

### 2. M√©tricas de Deploy

#### Coleta de M√©tricas
```bash
# Tempo de deploy
echo "Deploy iniciado: $(date)" > deploy-metrics.log

# Executar deploy
time firebase deploy >> deploy-metrics.log 2>&1

# M√©tricas p√≥s-deploy
echo "Deploy conclu√≠do: $(date)" >> deploy-metrics.log
node scripts/collectDeployMetrics.js >> deploy-metrics.log
```

## Troubleshooting de Deploy

### Problemas Comuns

#### 1. Falha no Build
```bash
# Limpar cache e rebuildar
npm run clean
rm -rf node_modules package-lock.json
npm install
npm run build
```

#### 2. Erro de Permiss√µes Firebase
```bash
# Re-autenticar
firebase logout
firebase login

# Verificar projeto
firebase use
firebase projects:list
```

#### 3. Timeout no Deploy
```bash
# Deploy com timeout aumentado
firebase deploy --timeout=600s

# Deploy por partes
firebase deploy --only hosting
firebase deploy --only functions
```

#### 4. Falha na Valida√ß√£o
```bash
# Debug da valida√ß√£o
node scripts/validateEnvironment.js --debug

# Pular valida√ß√µes n√£o-cr√≠ticas (emerg√™ncia)
SKIP_VALIDATION=true npm run deploy
```

## Automa√ß√£o de Deploy

### 1. GitHub Actions

#### Workflow de Deploy
```yaml
# .github/workflows/deploy.yml
name: Deploy to Firebase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:ci
    
    - name: Build
      run: npm run build:production
    
    - name: Deploy to Firebase
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: your-project-id
```

### 2. Hooks de Deploy

#### Pre-deploy Hook
```bash
#!/bin/bash
# .git/hooks/pre-push

echo "üîç Executando valida√ß√µes pr√©-deploy..."

# Executar testes
npm run test || {
  echo "‚ùå Testes falharam"
  exit 1
}

# Validar configura√ß√µes
node scripts/validateEnvironment.js || {
  echo "‚ùå Configura√ß√µes inv√°lidas"
  exit 1
}

echo "‚úÖ Valida√ß√µes passaram"
```

## Backup e Recupera√ß√£o

### 1. Backup Pr√©-Deploy
```bash
#!/bin/bash
# scripts/backup-before-deploy.sh

backup_dir="backups/pre-deploy-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$backup_dir"

# Backup do c√≥digo atual
git archive HEAD | tar -x -C "$backup_dir"

# Backup das configura√ß√µes
cp -r .env* "$backup_dir/"
cp firebase.json "$backup_dir/"

# Backup do banco de dados
node scripts/backup-firestore.js "$backup_dir/firestore-backup.json"

echo "‚úÖ Backup salvo em: $backup_dir"
```

### 2. Recupera√ß√£o de Desastre
```bash
#!/bin/bash
# scripts/disaster-recovery.sh

echo "üö® PROCEDIMENTO DE RECUPERA√á√ÉO DE DESASTRE"

# 1. Rollback para √∫ltima vers√£o est√°vel
firebase hosting:clone LAST_STABLE_VERSION

# 2. Restaurar functions cr√≠ticas
firebase deploy --only functions:critical --source=./backups/stable/

# 3. Verificar integridade do sistema
node scripts/systemStatus.js --emergency

# 4. Notificar equipe
node scripts/notifyEmergency.js "Sistema restaurado ap√≥s falha cr√≠tica"

echo "‚úÖ Recupera√ß√£o de desastre conclu√≠da"
```

## Checklist de Deploy

### ‚úÖ Pr√©-Deploy
- [ ] C√≥digo atualizado e testado
- [ ] Configura√ß√µes validadas
- [ ] Backup realizado
- [ ] Testes passando
- [ ] Depend√™ncias atualizadas

### ‚úÖ Durante Deploy
- [ ] Build bem-sucedido
- [ ] Deploy sem erros
- [ ] Valida√ß√µes p√≥s-deploy passando
- [ ] M√©tricas coletadas

### ‚úÖ P√≥s-Deploy
- [ ] Sistema funcionando
- [ ] Performance adequada
- [ ] Monitoramento ativo
- [ ] Documenta√ß√£o atualizada
- [ ] Equipe notificada

## Contatos de Emerg√™ncia

Para problemas cr√≠ticos de deploy:
1. **Rollback Autom√°tico:** `npm run rollback:emergency`
2. **Suporte T√©cnico:** Executar `node scripts/escalate.js --deploy-critical`
3. **Backup Manual:** Seguir `docs/backup/MANUAL_RECOVERY.md`