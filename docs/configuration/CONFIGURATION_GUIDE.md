# Guia de Configura√ß√£o - Plataforma Curva Mestra

## Vis√£o Geral

Este guia fornece instru√ß√µes detalhadas para configurar todos os componentes da plataforma Curva Mestra, incluindo vari√°veis de ambiente, Firebase, e configura√ß√µes de desenvolvimento e produ√ß√£o.

## Estrutura de Configura√ß√£o

```
projeto/
‚îú‚îÄ‚îÄ .env                          # Configura√ß√µes raiz
‚îú‚îÄ‚îÄ .env.example                  # Template de configura√ß√µes
‚îú‚îÄ‚îÄ .env.production.example       # Template para produ√ß√£o
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ .env                      # Configura√ß√µes frontend
‚îÇ   ‚îú‚îÄ‚îÄ .env.example              # Template frontend
‚îÇ   ‚îî‚îÄ‚îÄ .env.production           # Configura√ß√µes produ√ß√£o frontend
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ .env                      # Configura√ß√µes backend
‚îÇ   ‚îú‚îÄ‚îÄ .env.example              # Template backend
‚îÇ   ‚îú‚îÄ‚îÄ .env.production           # Configura√ß√µes produ√ß√£o backend
‚îÇ   ‚îî‚îÄ‚îÄ .env.test                 # Configura√ß√µes para testes
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îî‚îÄ‚îÄ .env.production           # Configura√ß√µes Firebase Functions
‚îî‚îÄ‚îÄ firebase.json                 # Configura√ß√µes Firebase
```

## Configura√ß√µes Firebase

### 1. Configura√ß√£o B√°sica

#### Vari√°veis Obrigat√≥rias (Frontend)
```env
# Firebase Configuration
VITE_FIREBASE_API_KEY=your_api_key_here
VITE_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your_project_id
VITE_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=123456789
VITE_FIREBASE_APP_ID=1:123456789:web:abcdef123456
```

#### Vari√°veis Obrigat√≥rias (Backend)
```env
# Firebase Admin Configuration
FIREBASE_PROJECT_ID=your_project_id
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your_project.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY\n-----END PRIVATE KEY-----\n"
FIREBASE_DATABASE_URL=https://your_project-default-rtdb.firebaseio.com
```

### 2. Obter Configura√ß√µes Firebase

#### Passo 1: Console Firebase
1. Acesse [Firebase Console](https://console.firebase.google.com)
2. Selecione seu projeto
3. V√° em "Configura√ß√µes do projeto" (√≠cone de engrenagem)
4. Na aba "Geral", role at√© "Seus apps"
5. Clique no √≠cone de configura√ß√£o (</>) para app web
6. Copie as configura√ß√µes mostradas

#### Passo 2: Service Account (Backend)
1. No Firebase Console, v√° em "Configura√ß√µes do projeto"
2. Aba "Contas de servi√ßo"
3. Clique em "Gerar nova chave privada"
4. Baixe o arquivo JSON
5. Extraia as informa√ß√µes necess√°rias:
   - `project_id` ‚Üí `FIREBASE_PROJECT_ID`
   - `client_email` ‚Üí `FIREBASE_CLIENT_EMAIL`
   - `private_key` ‚Üí `FIREBASE_PRIVATE_KEY`

### 3. Valida√ß√£o de Configura√ß√£o

#### Script de Valida√ß√£o
```bash
# Validar configura√ß√µes Firebase
node scripts/validateEnvironment.js --firebase

# Testar conectividade
node scripts/testFirebaseInit.js

# Verificar permiss√µes
node scripts/testFirebasePermissions.js
```

## Configura√ß√µes de Ambiente

### Desenvolvimento (.env)
```env
# Environment
NODE_ENV=development
PORT=3000
BACKEND_PORT=5000

# Firebase (Development)
VITE_FIREBASE_API_KEY=dev_api_key
VITE_FIREBASE_AUTH_DOMAIN=dev-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=dev-project-id

# API Configuration
API_BASE_URL=http://localhost:5000
FRONTEND_URL=http://localhost:3000

# Debug
DEBUG_MODE=true
LOG_LEVEL=debug
ENABLE_CORS=true
```

### Produ√ß√£o (.env.production)
```env
# Environment
NODE_ENV=production
PORT=443
BACKEND_PORT=8080

# Firebase (Production)
VITE_FIREBASE_API_KEY=prod_api_key
VITE_FIREBASE_AUTH_DOMAIN=prod-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=prod-project-id

# API Configuration
API_BASE_URL=https://api.curvamestra.com
FRONTEND_URL=https://curvamestra.com

# Security
ENABLE_CORS=false
LOG_LEVEL=error
RATE_LIMIT_ENABLED=true
```

### Testes (.env.test)
```env
# Environment
NODE_ENV=test
PORT=3001
BACKEND_PORT=5001

# Firebase (Test)
VITE_FIREBASE_API_KEY=test_api_key
VITE_FIREBASE_AUTH_DOMAIN=test-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=test-project-id

# Test Configuration
TEST_TIMEOUT=30000
MOCK_FIREBASE=true
DISABLE_AUTH=true
```

## Configura√ß√µes Espec√≠ficas por Componente

### Frontend (Vite)
```javascript
// vite.config.js
export default defineConfig({
  plugins: [react()],
  server: {
    port: parseInt(process.env.PORT) || 3000,
    host: true,
    cors: process.env.ENABLE_CORS === 'true'
  },
  build: {
    outDir: 'dist',
    sourcemap: process.env.NODE_ENV === 'development'
  },
  define: {
    'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV)
  }
});
```

### Backend (Express)
```javascript
// backend/src/config/index.js
module.exports = {
  port: process.env.BACKEND_PORT || 5000,
  cors: {
    origin: process.env.FRONTEND_URL || 'http://localhost:3000',
    credentials: true
  },
  firebase: {
    projectId: process.env.FIREBASE_PROJECT_ID,
    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
    privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n')
  },
  logging: {
    level: process.env.LOG_LEVEL || 'info',
    file: process.env.LOG_FILE || 'logs/app.log'
  }
};
```

### Firebase Functions
```javascript
// functions/src/config/index.js
const functions = require('firebase-functions');

module.exports = {
  cors: {
    origin: functions.config().app?.frontend_url || 'http://localhost:3000'
  },
  auth: {
    adminEmail: functions.config().auth?.admin_email
  },
  api: {
    timeout: 30000,
    retries: 3
  }
};
```

## Configura√ß√µes de Seguran√ßa

### Firestore Rules
```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Usu√°rios podem ler/escrever seus pr√≥prios dados
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Apenas admins podem acessar dados administrativos
    match /admin/{document=**} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true;
    }
    
    // Dados p√∫blicos (somente leitura)
    match /public/{document=**} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.token.admin == true;
    }
  }
}
```

### Storage Rules
```javascript
// storage.rules
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Usu√°rios podem fazer upload de seus pr√≥prios arquivos
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    // Arquivos p√∫blicos
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.token.admin == true;
    }
  }
}
```

## Configura√ß√µes de Monitoramento

### Logging
```env
# Logging Configuration
LOG_LEVEL=info                    # debug, info, warn, error
LOG_FILE=logs/app.log            # Arquivo de log
LOG_MAX_SIZE=10MB                # Tamanho m√°ximo do arquivo
LOG_MAX_FILES=5                  # N√∫mero m√°ximo de arquivos
ENABLE_CONSOLE_LOG=true          # Log no console
```

### M√©tricas
```env
# Metrics Configuration
ENABLE_METRICS=true              # Ativar coleta de m√©tricas
METRICS_INTERVAL=60000           # Intervalo de coleta (ms)
METRICS_RETENTION=7d             # Reten√ß√£o de dados
ALERT_EMAIL=admin@curvamestra.com # Email para alertas
```

### Health Checks
```env
# Health Check Configuration
HEALTH_CHECK_INTERVAL=30000      # Intervalo de verifica√ß√£o (ms)
HEALTH_CHECK_TIMEOUT=5000        # Timeout para verifica√ß√µes (ms)
ENABLE_AUTO_RECOVERY=true        # Recupera√ß√£o autom√°tica
```

## Configura√ß√µes de Performance

### Cache
```env
# Cache Configuration
ENABLE_CACHE=true                # Ativar cache
CACHE_TTL=300000                 # TTL padr√£o (ms)
CACHE_MAX_SIZE=100MB             # Tamanho m√°ximo do cache
REDIS_URL=redis://localhost:6379 # URL do Redis (se usado)
```

### Rate Limiting
```env
# Rate Limiting
RATE_LIMIT_ENABLED=true          # Ativar rate limiting
RATE_LIMIT_WINDOW=900000         # Janela de tempo (ms)
RATE_LIMIT_MAX_REQUESTS=100      # M√°ximo de requisi√ß√µes por janela
RATE_LIMIT_SKIP_SUCCESSFUL=true  # Pular requisi√ß√µes bem-sucedidas
```

## Valida√ß√£o de Configura√ß√£o

### Script de Valida√ß√£o Autom√°tica
```bash
#!/bin/bash
# scripts/validate-config.sh

echo "üîç Validando configura√ß√µes..."

# Verificar arquivos de configura√ß√£o obrigat√≥rios
required_files=(".env" "firebase.json" "frontend/.env" "backend/.env")
for file in "${required_files[@]}"; do
  if [ ! -f "$file" ]; then
    echo "‚ùå Arquivo obrigat√≥rio n√£o encontrado: $file"
    exit 1
  fi
done

# Validar vari√°veis Firebase
node scripts/validateEnvironment.js --firebase

# Testar conectividade
node scripts/testFirebaseInit.js

# Verificar permiss√µes
node scripts/testFirebasePermissions.js

echo "‚úÖ Configura√ß√µes validadas com sucesso!"
```

### Checklist de Configura√ß√£o

#### ‚úÖ Configura√ß√£o Inicial
- [ ] Arquivo `.env` criado e configurado
- [ ] Configura√ß√µes Firebase definidas
- [ ] Service Account configurado
- [ ] Regras Firestore definidas
- [ ] Regras Storage definidas

#### ‚úÖ Configura√ß√£o de Desenvolvimento
- [ ] Vari√°veis de desenvolvimento configuradas
- [ ] CORS habilitado para desenvolvimento
- [ ] Debug mode ativado
- [ ] Logs detalhados habilitados

#### ‚úÖ Configura√ß√£o de Produ√ß√£o
- [ ] Vari√°veis de produ√ß√£o configuradas
- [ ] HTTPS configurado
- [ ] Rate limiting ativado
- [ ] Logs de produ√ß√£o configurados
- [ ] Monitoramento ativado

#### ‚úÖ Configura√ß√£o de Seguran√ßa
- [ ] Chaves privadas protegidas
- [ ] Regras de seguran√ßa implementadas
- [ ] CORS configurado corretamente
- [ ] Autentica√ß√£o funcionando

#### ‚úÖ Configura√ß√£o de Performance
- [ ] Cache configurado
- [ ] Rate limiting implementado
- [ ] Otimiza√ß√µes de build aplicadas
- [ ] CDN configurado (se aplic√°vel)

## Troubleshooting de Configura√ß√£o

### Problemas Comuns

#### 1. Erro "Firebase project not found"
**Causa:** `FIREBASE_PROJECT_ID` incorreto
**Solu√ß√£o:**
```bash
# Verificar projeto ativo
firebase use

# Listar projetos dispon√≠veis
firebase projects:list

# Definir projeto correto
firebase use your-project-id
```

#### 2. Erro "Permission denied"
**Causa:** Service Account sem permiss√µes
**Solu√ß√£o:**
1. Verificar se o Service Account tem as roles necess√°rias
2. Regenerar chave privada se necess√°rio
3. Verificar se `FIREBASE_PRIVATE_KEY` est√° formatado corretamente

#### 3. Erro de CORS
**Causa:** Configura√ß√£o CORS incorreta
**Solu√ß√£o:**
```javascript
// backend/src/middleware/cors.js
const corsOptions = {
  origin: process.env.FRONTEND_URL,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
};
```

### Ferramentas de Debug
```bash
# Validar todas as configura√ß√µes
node scripts/validateEnvironment.js --all

# Testar configura√ß√£o espec√≠fica
node scripts/validateEnvironment.js --firebase
node scripts/validateEnvironment.js --cors
node scripts/validateEnvironment.js --auth

# Debug de configura√ß√£o
node scripts/debug/debugToolkit.js firebase
```

## Backup de Configura√ß√£o

### Script de Backup
```bash
#!/bin/bash
# scripts/backup-config.sh

backup_dir="backups/config-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$backup_dir"

# Backup de arquivos de configura√ß√£o (sem dados sens√≠veis)
cp .env.example "$backup_dir/"
cp firebase.json "$backup_dir/"
cp firestore.rules "$backup_dir/"
cp storage.rules "$backup_dir/"

echo "‚úÖ Backup de configura√ß√£o salvo em: $backup_dir"
```

## Atualiza√ß√µes de Configura√ß√£o

### Processo de Atualiza√ß√£o
1. **Backup:** Sempre fazer backup antes de mudan√ßas
2. **Valida√ß√£o:** Testar configura√ß√µes em ambiente de desenvolvimento
3. **Deploy:** Aplicar mudan√ßas em produ√ß√£o gradualmente
4. **Monitoramento:** Monitorar sistema ap√≥s mudan√ßas

### Versionamento de Configura√ß√£o
- Usar Git para versionar arquivos `.example`
- Documentar mudan√ßas no `CHANGELOG.md`
- Manter hist√≥rico de configura√ß√µes cr√≠ticas