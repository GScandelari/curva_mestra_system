# Guia de Monitoramento - Plataforma Curva Mestra

## Vis√£o Geral

Este guia fornece instru√ß√µes completas para configurar, usar e manter o sistema de monitoramento da plataforma Curva Mestra, incluindo m√©tricas, alertas, dashboards e troubleshooting.

## Arquitetura de Monitoramento

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Coleta de     ‚îÇ    ‚îÇ   Processamento ‚îÇ    ‚îÇ   Visualiza√ß√£o  ‚îÇ
‚îÇ   M√©tricas      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   e Alertas     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   e Dashboards  ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Frontend      ‚îÇ    ‚îÇ ‚Ä¢ Agrega√ß√£o     ‚îÇ    ‚îÇ ‚Ä¢ Dashboard     ‚îÇ
‚îÇ ‚Ä¢ Backend       ‚îÇ    ‚îÇ ‚Ä¢ An√°lise       ‚îÇ    ‚îÇ ‚Ä¢ Alertas       ‚îÇ
‚îÇ ‚Ä¢ Firebase      ‚îÇ    ‚îÇ ‚Ä¢ Correla√ß√£o    ‚îÇ    ‚îÇ ‚Ä¢ Relat√≥rios    ‚îÇ
‚îÇ ‚Ä¢ Infraestrutura‚îÇ    ‚îÇ ‚Ä¢ Alertas       ‚îÇ    ‚îÇ ‚Ä¢ Notifica√ß√µes  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Configura√ß√£o Inicial

### 1. Instala√ß√£o e Setup

#### Depend√™ncias
```bash
# Instalar depend√™ncias de monitoramento
npm install --save-dev @types/node
npm install winston prometheus-client prom-client

# Configurar ferramentas de monitoramento
node scripts/setup-monitoring.js
```

#### Configura√ß√£o B√°sica
```env
# Configura√ß√µes de Monitoramento (.env)
ENABLE_MONITORING=true
METRICS_COLLECTION_INTERVAL=60000
METRICS_RETENTION_DAYS=30
ALERT_EMAIL=admin@curvamestra.com
ALERT_WEBHOOK_URL=https://hooks.slack.com/your-webhook
LOG_LEVEL=info
PERFORMANCE_MONITORING=true
ERROR_TRACKING=true
```

### 2. Inicializa√ß√£o do Sistema

#### Script de Inicializa√ß√£o
```javascript
// scripts/initMonitoring.js
const { MonitoringSystem } = require('../shared/utils/MonitoringSystem');

async function initializeMonitoring() {
  console.log('üîß Inicializando sistema de monitoramento...');
  
  const monitoring = new MonitoringSystem({
    metricsInterval: process.env.METRICS_COLLECTION_INTERVAL || 60000,
    retentionDays: process.env.METRICS_RETENTION_DAYS || 30,
    alertEmail: process.env.ALERT_EMAIL,
    enablePerformanceMonitoring: process.env.PERFORMANCE_MONITORING === 'true'
  });
  
  // Inicializar coleta de m√©tricas
  await monitoring.startMetricsCollection();
  
  // Configurar alertas
  await monitoring.setupAlerts();
  
  // Iniciar health checks
  await monitoring.startHealthChecks();
  
  console.log('‚úÖ Sistema de monitoramento inicializado');
}

initializeMonitoring().catch(console.error);
```

## M√©tricas Coletadas

### 1. M√©tricas de Sistema

#### Performance da Aplica√ß√£o
```javascript
// M√©tricas coletadas automaticamente
const systemMetrics = {
  // Performance
  responseTime: 'Tempo de resposta m√©dio (ms)',
  throughput: 'Requisi√ß√µes por segundo',
  errorRate: 'Taxa de erro (%)',
  
  // Recursos
  cpuUsage: 'Uso de CPU (%)',
  memoryUsage: 'Uso de mem√≥ria (MB)',
  diskUsage: 'Uso de disco (%)',
  
  // Rede
  networkLatency: 'Lat√™ncia de rede (ms)',
  bandwidthUsage: 'Uso de banda (MB/s)',
  
  // Aplica√ß√£o
  activeUsers: 'Usu√°rios ativos',
  sessionDuration: 'Dura√ß√£o m√©dia de sess√£o (min)',
  pageLoadTime: 'Tempo de carregamento de p√°gina (ms)'
};
```

#### M√©tricas Firebase
```javascript
// M√©tricas espec√≠ficas do Firebase
const firebaseMetrics = {
  // Firestore
  firestoreReads: 'Leituras Firestore por minuto',
  firestoreWrites: 'Escritas Firestore por minuto',
  firestoreDeletes: 'Exclus√µes Firestore por minuto',
  
  // Authentication
  authSignIns: 'Logins por hora',
  authSignUps: 'Registros por hora',
  authErrors: 'Erros de autentica√ß√£o por hora',
  
  // Functions
  functionInvocations: 'Invoca√ß√µes de Functions',
  functionDuration: 'Dura√ß√£o m√©dia de Functions (ms)',
  functionErrors: 'Erros em Functions',
  
  // Hosting
  hostingRequests: 'Requisi√ß√µes de Hosting',
  hostingBandwidth: 'Banda utilizada (GB)',
  hostingCacheHitRate: 'Taxa de acerto do cache (%)'
};
```

### 2. M√©tricas Customizadas

#### M√©tricas de Neg√≥cio
```javascript
// Definir m√©tricas espec√≠ficas do neg√≥cio
const businessMetrics = {
  // Usu√°rios
  newUserRegistrations: 'Novos registros de usu√°rio',
  userRetentionRate: 'Taxa de reten√ß√£o de usu√°rios (%)',
  dailyActiveUsers: 'Usu√°rios ativos di√°rios',
  
  // Funcionalidades
  invoicesCreated: 'Faturas criadas',
  reportsGenerated: 'Relat√≥rios gerados',
  patientsRegistered: 'Pacientes cadastrados',
  
  // Performance de Neg√≥cio
  averageSessionValue: 'Valor m√©dio por sess√£o',
  conversionRate: 'Taxa de convers√£o (%)',
  featureUsageRate: 'Taxa de uso de funcionalidades (%)'
};
```

## Dashboards

### 1. Dashboard Principal

#### Vis√£o Geral do Sistema
```javascript
// Configura√ß√£o do dashboard principal
const mainDashboard = {
  title: 'Curva Mestra - Vis√£o Geral',
  refreshInterval: 30000, // 30 segundos
  
  widgets: [
    {
      type: 'metric',
      title: 'Status do Sistema',
      metric: 'system.health',
      thresholds: {
        good: 95,
        warning: 85,
        critical: 70
      }
    },
    {
      type: 'chart',
      title: 'Tempo de Resposta',
      metric: 'performance.responseTime',
      timeRange: '1h',
      chartType: 'line'
    },
    {
      type: 'chart',
      title: 'Taxa de Erro',
      metric: 'errors.rate',
      timeRange: '24h',
      chartType: 'area'
    },
    {
      type: 'table',
      title: 'Componentes Cr√≠ticos',
      data: 'components.health',
      columns: ['component', 'status', 'lastCheck']
    }
  ]
};
```

### 2. Dashboard de Performance

#### M√©tricas de Performance Detalhadas
```javascript
const performanceDashboard = {
  title: 'Performance - An√°lise Detalhada',
  
  sections: [
    {
      title: 'Frontend Performance',
      widgets: [
        'frontend.loadTime',
        'frontend.renderTime',
        'frontend.bundleSize',
        'frontend.cacheHitRate'
      ]
    },
    {
      title: 'Backend Performance',
      widgets: [
        'backend.responseTime',
        'backend.throughput',
        'backend.queueLength',
        'backend.dbConnectionPool'
      ]
    },
    {
      title: 'Firebase Performance',
      widgets: [
        'firebase.functionDuration',
        'firebase.firestoreLatency',
        'firebase.authLatency',
        'firebase.quotaUsage'
      ]
    }
  ]
};
```

### 3. Dashboard de Erros

#### Monitoramento de Erros e Problemas
```javascript
const errorDashboard = {
  title: 'Monitoramento de Erros',
  
  widgets: [
    {
      type: 'alert-summary',
      title: 'Alertas Ativos',
      showCritical: true,
      showWarning: true
    },
    {
      type: 'error-trends',
      title: 'Tend√™ncia de Erros',
      timeRange: '7d',
      groupBy: 'errorType'
    },
    {
      type: 'error-details',
      title: 'Erros Recentes',
      limit: 50,
      showStackTrace: true
    },
    {
      type: 'recovery-status',
      title: 'Status de Recupera√ß√£o',
      showAutoRecovery: true,
      showManualActions: true
    }
  ]
};
```

## Sistema de Alertas

### 1. Configura√ß√£o de Alertas

#### Regras de Alerta
```javascript
// Configura√ß√£o de alertas
const alertRules = [
  {
    name: 'High Error Rate',
    condition: 'errors.rate > 5%',
    severity: 'critical',
    duration: '5m',
    actions: ['email', 'slack', 'auto-recovery']
  },
  {
    name: 'Slow Response Time',
    condition: 'performance.responseTime > 2000ms',
    severity: 'warning',
    duration: '10m',
    actions: ['email']
  },
  {
    name: 'System Down',
    condition: 'system.health < 50%',
    severity: 'critical',
    duration: '1m',
    actions: ['email', 'slack', 'sms', 'auto-recovery']
  },
  {
    name: 'High Memory Usage',
    condition: 'system.memoryUsage > 85%',
    severity: 'warning',
    duration: '15m',
    actions: ['email', 'cleanup']
  },
  {
    name: 'Firebase Quota Near Limit',
    condition: 'firebase.quotaUsage > 90%',
    severity: 'warning',
    duration: '1h',
    actions: ['email', 'optimize']
  }
];
```

### 2. Canais de Notifica√ß√£o

#### Email
```javascript
// Configura√ß√£o de alertas por email
const emailConfig = {
  smtp: {
    host: 'smtp.gmail.com',
    port: 587,
    secure: false,
    auth: {
      user: process.env.ALERT_EMAIL_USER,
      pass: process.env.ALERT_EMAIL_PASS
    }
  },
  templates: {
    critical: 'templates/alert-critical.html',
    warning: 'templates/alert-warning.html',
    recovery: 'templates/alert-recovery.html'
  },
  recipients: {
    critical: ['admin@curvamestra.com', 'dev@curvamestra.com'],
    warning: ['admin@curvamestra.com'],
    info: ['logs@curvamestra.com']
  }
};
```

#### Slack
```javascript
// Configura√ß√£o de alertas Slack
const slackConfig = {
  webhookUrl: process.env.SLACK_WEBHOOK_URL,
  channels: {
    critical: '#alerts-critical',
    warning: '#alerts-warning',
    info: '#monitoring'
  },
  messageFormat: {
    critical: 'üö® *CR√çTICO*: {title}\n{description}\n*A√ß√£o:* {action}',
    warning: '‚ö†Ô∏è *AVISO*: {title}\n{description}',
    recovery: '‚úÖ *RECUPERADO*: {title}\n{description}'
  }
};
```

## Health Checks

### 1. Health Checks Autom√°ticos

#### Verifica√ß√µes de Sistema
```javascript
// Health checks configurados
const healthChecks = [
  {
    name: 'Frontend Accessibility',
    type: 'http',
    url: 'https://curvamestra.com/health',
    interval: '30s',
    timeout: '10s',
    expectedStatus: 200
  },
  {
    name: 'API Endpoints',
    type: 'http',
    url: 'https://api.curvamestra.com/health',
    interval: '1m',
    timeout: '15s',
    expectedStatus: 200
  },
  {
    name: 'Firebase Connectivity',
    type: 'custom',
    function: 'checkFirebaseConnectivity',
    interval: '2m',
    timeout: '30s'
  },
  {
    name: 'Database Performance',
    type: 'custom',
    function: 'checkDatabasePerformance',
    interval: '5m',
    timeout: '1m'
  }
];
```

### 2. Health Checks Customizados

#### Verifica√ß√µes Espec√≠ficas
```javascript
// Implementa√ß√£o de health checks customizados
class CustomHealthChecks {
  
  async checkFirebaseConnectivity() {
    try {
      // Testar Firestore
      await admin.firestore().collection('health').doc('test').get();
      
      // Testar Auth
      await admin.auth().listUsers(1);
      
      // Testar Functions
      const response = await fetch('https://us-central1-project.cloudfunctions.net/health');
      
      return {
        status: 'healthy',
        details: {
          firestore: 'ok',
          auth: 'ok',
          functions: response.ok ? 'ok' : 'degraded'
        }
      };
    } catch (error) {
      return {
        status: 'unhealthy',
        error: error.message
      };
    }
  }
  
  async checkDatabasePerformance() {
    const startTime = Date.now();
    
    try {
      // Executar query de teste
      await admin.firestore()
        .collection('performance_test')
        .limit(10)
        .get();
      
      const duration = Date.now() - startTime;
      
      return {
        status: duration < 1000 ? 'healthy' : 'degraded',
        responseTime: duration,
        threshold: 1000
      };
    } catch (error) {
      return {
        status: 'unhealthy',
        error: error.message
      };
    }
  }
}
```

## Logs e Auditoria

### 1. Configura√ß√£o de Logs

#### Estrutura de Logs
```javascript
// Configura√ß√£o do sistema de logs
const logConfig = {
  level: process.env.LOG_LEVEL || 'info',
  format: 'json',
  
  transports: [
    // Console (desenvolvimento)
    {
      type: 'console',
      level: 'debug',
      format: 'simple'
    },
    
    // Arquivo (produ√ß√£o)
    {
      type: 'file',
      filename: 'logs/app.log',
      level: 'info',
      maxSize: '10MB',
      maxFiles: 5,
      format: 'json'
    },
    
    // Arquivo de erros
    {
      type: 'file',
      filename: 'logs/error.log',
      level: 'error',
      maxSize: '10MB',
      maxFiles: 10,
      format: 'json'
    }
  ],
  
  // Campos padr√£o em todos os logs
  defaultMeta: {
    service: 'curva-mestra',
    version: process.env.APP_VERSION,
    environment: process.env.NODE_ENV
  }
};
```

### 2. Auditoria de A√ß√µes

#### Log de Auditoria
```javascript
// Sistema de auditoria
class AuditLogger {
  
  logUserAction(userId, action, details) {
    this.log('audit', {
      type: 'user_action',
      userId,
      action,
      details,
      timestamp: new Date().toISOString(),
      ip: details.ip,
      userAgent: details.userAgent
    });
  }
  
  logSystemEvent(event, details) {
    this.log('audit', {
      type: 'system_event',
      event,
      details,
      timestamp: new Date().toISOString(),
      component: details.component
    });
  }
  
  logSecurityEvent(event, details) {
    this.log('security', {
      type: 'security_event',
      event,
      details,
      timestamp: new Date().toISOString(),
      severity: details.severity || 'medium'
    });
  }
}
```

## Ferramentas de Monitoramento

### 1. CLI de Monitoramento

#### Comandos Dispon√≠veis
```bash
# Status geral do sistema
node scripts/monitoring/status.js

# M√©tricas em tempo real
node scripts/monitoring/metrics.js --live

# Verificar alertas ativos
node scripts/monitoring/alerts.js --active

# Executar health checks
node scripts/monitoring/health.js --all

# Gerar relat√≥rio
node scripts/monitoring/report.js --period=24h

# Limpar dados antigos
node scripts/monitoring/cleanup.js --older-than=30d
```

### 2. Interface Web

#### Dashboard Web
```javascript
// Servidor do dashboard web
const express = require('express');
const { MonitoringDashboard } = require('../shared/utils/MonitoringDashboard');

const app = express();
const dashboard = new MonitoringDashboard();

// Endpoint para m√©tricas
app.get('/api/metrics', async (req, res) => {
  const metrics = await dashboard.getCurrentMetrics();
  res.json(metrics);
});

// Endpoint para alertas
app.get('/api/alerts', async (req, res) => {
  const alerts = await dashboard.getActiveAlerts();
  res.json(alerts);
});

// Endpoint para health checks
app.get('/api/health', async (req, res) => {
  const health = await dashboard.getSystemHealth();
  res.json(health);
});

// Servir dashboard est√°tico
app.use(express.static('frontend/dist'));

app.listen(3001, () => {
  console.log('üìä Dashboard de monitoramento dispon√≠vel em http://localhost:3001');
});
```

## Troubleshooting de Monitoramento

### Problemas Comuns

#### 1. M√©tricas N√£o Coletadas
```bash
# Verificar se o servi√ßo est√° rodando
ps aux | grep monitoring

# Verificar logs do sistema de monitoramento
tail -f logs/monitoring.log

# Reiniciar coleta de m√©tricas
node scripts/monitoring/restart.js
```

#### 2. Alertas N√£o Funcionando
```bash
# Testar configura√ß√£o de alertas
node scripts/monitoring/test-alerts.js

# Verificar conectividade SMTP/Slack
node scripts/monitoring/test-notifications.js

# Verificar regras de alerta
node scripts/monitoring/validate-rules.js
```

#### 3. Dashboard N√£o Carregando
```bash
# Verificar se o servidor est√° rodando
curl http://localhost:3001/api/health

# Verificar logs do dashboard
tail -f logs/dashboard.log

# Reiniciar dashboard
npm run restart:dashboard
```

## Otimiza√ß√£o de Performance

### 1. Otimiza√ß√£o de Coleta

#### Configura√ß√µes Otimizadas
```javascript
// Configura√ß√µes para diferentes ambientes
const optimizedConfig = {
  development: {
    metricsInterval: 30000,    // 30 segundos
    retentionDays: 7,          // 1 semana
    detailedLogging: true
  },
  
  staging: {
    metricsInterval: 60000,    // 1 minuto
    retentionDays: 14,         // 2 semanas
    detailedLogging: false
  },
  
  production: {
    metricsInterval: 300000,   // 5 minutos
    retentionDays: 90,         // 3 meses
    detailedLogging: false,
    compression: true,
    sampling: 0.1              // 10% de amostragem
  }
};
```

### 2. Limpeza Autom√°tica

#### Script de Limpeza
```bash
#!/bin/bash
# scripts/monitoring/cleanup.sh

echo "üßπ Limpando dados antigos de monitoramento..."

# Limpar m√©tricas antigas (> 90 dias)
node scripts/monitoring/cleanup.js --metrics --older-than=90d

# Limpar logs antigos (> 30 dias)
find logs/ -name "*.log" -mtime +30 -delete

# Comprimir logs antigos
find logs/ -name "*.log" -mtime +7 -exec gzip {} \;

# Limpar alertas resolvidos (> 7 dias)
node scripts/monitoring/cleanup.js --alerts --resolved --older-than=7d

echo "‚úÖ Limpeza conclu√≠da"
```

## Backup de Dados de Monitoramento

### Script de Backup
```bash
#!/bin/bash
# scripts/monitoring/backup.sh

backup_dir="backups/monitoring-$(date +%Y%m%d)"
mkdir -p "$backup_dir"

# Backup de m√©tricas
node scripts/monitoring/export-metrics.js --output="$backup_dir/metrics.json"

# Backup de configura√ß√µes
cp -r config/monitoring/ "$backup_dir/config/"

# Backup de logs cr√≠ticos
cp logs/error.log "$backup_dir/"
cp logs/audit.log "$backup_dir/"

# Comprimir backup
tar -czf "$backup_dir.tar.gz" "$backup_dir"
rm -rf "$backup_dir"

echo "‚úÖ Backup de monitoramento salvo: $backup_dir.tar.gz"
```

## Integra√ß√£o com Ferramentas Externas

### 1. Prometheus
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'curva-mestra'
    static_configs:
      - targets: ['localhost:3001']
    metrics_path: '/metrics'
    scrape_interval: 30s
```

### 2. Grafana
```json
{
  "dashboard": {
    "title": "Curva Mestra Monitoring",
    "panels": [
      {
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "avg(response_time_seconds)",
            "legendFormat": "Average Response Time"
          }
        ]
      }
    ]
  }
}
```

## Checklist de Monitoramento

### ‚úÖ Configura√ß√£o Inicial
- [ ] Sistema de monitoramento instalado
- [ ] M√©tricas configuradas
- [ ] Alertas configurados
- [ ] Dashboard funcionando
- [ ] Health checks ativos

### ‚úÖ Opera√ß√£o Di√°ria
- [ ] Verificar alertas ativos
- [ ] Revisar m√©tricas de performance
- [ ] Validar health checks
- [ ] Verificar logs de erro
- [ ] Confirmar backup de dados

### ‚úÖ Manuten√ß√£o Semanal
- [ ] Limpar dados antigos
- [ ] Revisar regras de alerta
- [ ] Atualizar dashboards
- [ ] Verificar capacidade de armazenamento
- [ ] Testar procedimentos de recupera√ß√£o