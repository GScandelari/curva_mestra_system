# üìö API Documentation - Curva Mestra Admin System

## üåê Base URL
```
https://us-central1-curva-mestra.cloudfunctions.net
```

## üîê Authentication
Todas as fun√ß√µes requerem autentica√ß√£o Firebase. Inclua o token de autentica√ß√£o no header:
```
Authorization: Bearer <firebase-id-token>
```

---

## üìã Admin Initialization Endpoints

### 1. Initialize Default Admin
**Endpoint:** `POST /initializeDefaultAdmin`

**Descri√ß√£o:** Inicializa o usu√°rio administrador padr√£o do sistema com todas as permiss√µes necess√°rias.

**Autentica√ß√£o:** N√£o requerida (fun√ß√£o de inicializa√ß√£o do sistema)

**Request Body:**
```json
{
  "data": {}
}
```

**Response - Success (Admin j√° inicializado):**
```json
{
  "result": {
    "success": true,
    "message": "Admin user already initialized",
    "uid": "gEjUSOsHF9QmS0Dvi0zB10GsxrD2",
    "email": "scandelari.guilherme@hotmail.com",
    "alreadyAdmin": true,
    "claims": {
      "admin": true,
      "role": "administrator",
      "permissions": [
        "view_products", "manage_products", "view_requests", "approve_requests",
        "view_patients", "manage_patients", "view_invoices", "manage_invoices",
        "view_reports", "manage_users", "view_analytics", "manage_settings",
        "system_admin", "initialize_system"
      ],
      "assignedAt": "2025-10-21T14:00:00.000Z",
      "isDefaultAdmin": true
    }
  }
}
```

**Response - Success (Admin inicializado):**
```json
{
  "result": {
    "success": true,
    "message": "Default admin user initialized successfully",
    "uid": "gEjUSOsHF9QmS0Dvi0zB10GsxrD2",
    "email": "scandelari.guilherme@hotmail.com",
    "displayName": "System Administrator",
    "claims": {
      "admin": true,
      "role": "administrator",
      "permissions": [
        "view_products", "manage_products", "view_requests", "approve_requests",
        "view_patients", "manage_patients", "view_invoices", "manage_invoices",
        "view_reports", "manage_users", "view_analytics", "manage_settings",
        "system_admin", "initialize_system"
      ],
      "assignedAt": "2025-10-21T14:00:00.000Z",
      "isDefaultAdmin": true
    }
  }
}
```

**Response - Error (Usu√°rio n√£o encontrado):**
```json
{
  "error": {
    "code": "not-found",
    "message": "Default admin user with UID gEjUSOsHF9QmS0Dvi0zB10GsxrD2 not found. Please ensure the user is registered."
  }
}
```

**Postman Example:**
```javascript
// Pre-request Script
// N√£o necess√°rio para esta fun√ß√£o

// Request
POST https://us-central1-curva-mestra.cloudfunctions.net/initializeDefaultAdmin
Content-Type: application/json

{
  "data": {}
}
```

---

### 2. Validate Admin Initialization
**Endpoint:** `POST /validateAdminInitialization`

**Descri√ß√£o:** Valida se o administrador padr√£o foi inicializado corretamente.

**Autentica√ß√£o:** N√£o requerida

**Request Body:**
```json
{
  "data": {}
}
```

**Response - Success (Admin inicializado):**
```json
{
  "result": {
    "success": true,
    "isInitialized": true,
    "uid": "gEjUSOsHF9QmS0Dvi0zB10GsxrD2",
    "email": "scandelari.guilherme@hotmail.com",
    "expectedEmail": "scandelari.guilherme@hotmail.com",
    "emailMatches": true,
    "hasAdminClaims": true,
    "role": "administrator",
    "claims": {
      "admin": true,
      "role": "administrator",
      "permissions": [...],
      "assignedAt": "2025-10-21T14:00:00.000Z",
      "isDefaultAdmin": true
    }
  }
}
```

**Response - Success (Admin n√£o inicializado):**
```json
{
  "result": {
    "success": true,
    "isInitialized": false,
    "userExists": false,
    "uid": "gEjUSOsHF9QmS0Dvi0zB10GsxrD2",
    "expectedEmail": "scandelari.guilherme@hotmail.com",
    "error": "Default admin user not found"
  }
}
```

**Postman Example:**
```javascript
POST https://us-central1-curva-mestra.cloudfunctions.net/validateAdminInitialization
Content-Type: application/json

{
  "data": {}
}
```

---

### 3. Emergency Admin Assignment
**Endpoint:** `POST /emergencyAdminAssignment`

**Descri√ß√£o:** Atribui privil√©gios de administrador a qualquer usu√°rio em caso de emerg√™ncia.

**Autentica√ß√£o:** Requerida

**Request Body:**
```json
{
  "data": {
    "uid": "user-uid-to-make-admin",
    "email": "user@example.com"
  }
}
```

**Response - Success:**
```json
{
  "result": {
    "success": true,
    "message": "Emergency admin role assigned successfully",
    "uid": "user-uid-to-make-admin",
    "email": "user@example.com",
    "assignedBy": "current-admin-uid",
    "claims": {
      "admin": true,
      "role": "administrator",
      "permissions": [
        "view_products", "manage_products", "view_requests", "approve_requests",
        "view_patients", "manage_patients", "view_invoices", "manage_invoices",
        "view_reports", "manage_users", "view_analytics", "manage_settings",
        "system_admin", "emergency_admin"
      ],
      "assignedAt": "2025-10-21T14:00:00.000Z",
      "isEmergencyAdmin": true,
      "assignedBy": "current-admin-uid"
    }
  }
}
```

**Response - Error (N√£o autenticado):**
```json
{
  "error": {
    "code": "unauthenticated",
    "message": "User must be authenticated"
  }
}
```

**Response - Error (Par√¢metros inv√°lidos):**
```json
{
  "error": {
    "code": "invalid-argument",
    "message": "UID and email are required"
  }
}
```

**Postman Example:**
```javascript
// Pre-request Script
pm.test("Set Firebase Auth Token", function () {
    pm.request.headers.add({
        key: "Authorization",
        value: "Bearer " + pm.environment.get("firebase_token")
    });
});

// Request
POST https://us-central1-curva-mestra.cloudfunctions.net/emergencyAdminAssignment
Content-Type: application/json
Authorization: Bearer {{firebase_token}}

{
  "data": {
    "uid": "emergency-user-uid",
    "email": "emergency@example.com"
  }
}
```

---

## üë• User Role Management Endpoints

### 4. Set Admin Role
**Endpoint:** `POST /setAdminRole`

**Descri√ß√£o:** Atribui privil√©gios de administrador a um usu√°rio espec√≠fico.

**Autentica√ß√£o:** Requerida

**Request Body:**
```json
{
  "data": {
    "uid": "user-uid-to-make-admin"
  }
}
```

**Response - Success:**
```json
{
  "result": {
    "success": true,
    "message": "Admin role assigned to user user-uid-to-make-admin",
    "claims": {
      "admin": true,
      "role": "administrator",
      "permissions": [
        "view_products", "manage_products", "view_requests", "approve_requests",
        "view_patients", "manage_patients", "view_invoices", "manage_invoices",
        "view_reports", "manage_users", "view_analytics", "manage_settings",
        "system_admin"
      ],
      "assignedAt": "2025-10-21T14:00:00.000Z"
    },
    "userEmail": "user@example.com"
  }
}
```

**Response - Error (Usu√°rio n√£o encontrado):**
```json
{
  "error": {
    "code": "not-found",
    "message": "User not found"
  }
}
```

**Postman Example:**
```javascript
POST https://us-central1-curva-mestra.cloudfunctions.net/setAdminRole
Content-Type: application/json
Authorization: Bearer {{firebase_token}}

{
  "data": {
    "uid": "target-user-uid"
  }
}
```

---

### 5. Verify Admin Role
**Endpoint:** `POST /verifyAdminRole`

**Descri√ß√£o:** Verifica se um usu√°rio possui privil√©gios de administrador.

**Autentica√ß√£o:** Requerida

**Request Body (verificar outro usu√°rio):**
```json
{
  "data": {
    "uid": "user-uid-to-verify"
  }
}
```

**Request Body (verificar usu√°rio atual):**
```json
{
  "data": {}
}
```

**Response - Success (√â admin):**
```json
{
  "result": {
    "success": true,
    "isAdmin": true,
    "uid": "user-uid-to-verify",
    "email": "user@example.com",
    "claims": {
      "admin": true,
      "role": "administrator",
      "permissions": [...],
      "assignedAt": "2025-10-21T14:00:00.000Z"
    }
  }
}
```

**Response - Success (N√£o √© admin):**
```json
{
  "result": {
    "success": true,
    "isAdmin": false,
    "uid": "user-uid-to-verify",
    "email": "user@example.com",
    "claims": {}
  }
}
```

**Postman Example:**
```javascript
// Verificar outro usu√°rio
POST https://us-central1-curva-mestra.cloudfunctions.net/verifyAdminRole
Content-Type: application/json
Authorization: Bearer {{firebase_token}}

{
  "data": {
    "uid": "target-user-uid"
  }
}

// Verificar usu√°rio atual
POST https://us-central1-curva-mestra.cloudfunctions.net/verifyAdminRole
Content-Type: application/json
Authorization: Bearer {{firebase_token}}

{
  "data": {}
}
```

---

### 6. Get User Role
**Endpoint:** `POST /getUserRole`

**Descri√ß√£o:** Obt√©m informa√ß√µes detalhadas sobre o papel e permiss√µes de um usu√°rio.

**Autentica√ß√£o:** Requerida

**Request Body (obter role de outro usu√°rio):**
```json
{
  "data": {
    "uid": "user-uid-to-get-role"
  }
}
```

**Request Body (obter role do usu√°rio atual):**
```json
{
  "data": {}
}
```

**Response - Success (Admin):**
```json
{
  "result": {
    "success": true,
    "uid": "user-uid",
    "email": "user@example.com",
    "displayName": "User Name",
    "role": "administrator",
    "isAdmin": true,
    "permissions": [
      "view_products", "manage_products", "view_requests", "approve_requests",
      "view_patients", "manage_patients", "view_invoices", "manage_invoices",
      "view_reports", "manage_users", "view_analytics", "manage_settings",
      "system_admin"
    ],
    "assignedAt": "2025-10-21T14:00:00.000Z"
  }
}
```

**Response - Success (Usu√°rio comum):**
```json
{
  "result": {
    "success": true,
    "uid": "user-uid",
    "email": "user@example.com",
    "displayName": "User Name",
    "role": "user",
    "isAdmin": false,
    "permissions": [],
    "assignedAt": null
  }
}
```

**Postman Example:**
```javascript
POST https://us-central1-curva-mestra.cloudfunctions.net/getUserRole
Content-Type: application/json
Authorization: Bearer {{firebase_token}}

{
  "data": {
    "uid": "target-user-uid"
  }
}
```

---

## üîß Postman Collection Setup

### Environment Variables
Crie um ambiente no Postman com as seguintes vari√°veis:

```json
{
  "base_url": "https://us-central1-curva-mestra.cloudfunctions.net",
  "firebase_token": "your-firebase-id-token-here",
  "admin_uid": "gEjUSOsHF9QmS0Dvi0zB10GsxrD2",
  "admin_email": "scandelari.guilherme@hotmail.com",
  "test_user_uid": "test-user-uid",
  "test_user_email": "test@example.com"
}
```

### Pre-request Script Global
Adicione este script global para todas as requisi√ß√µes autenticadas:

```javascript
// Adicionar token de autentica√ß√£o se dispon√≠vel
if (pm.environment.get("firebase_token")) {
    pm.request.headers.add({
        key: "Authorization",
        value: "Bearer " + pm.environment.get("firebase_token")
    });
}

// Log da requisi√ß√£o
console.log("Request URL:", pm.request.url.toString());
console.log("Request Method:", pm.request.method);
```

### Test Script Global
Adicione este script de teste global:

```javascript
// Verificar se a resposta √© v√°lida
pm.test("Response is valid JSON", function () {
    pm.response.to.be.json;
});

// Verificar status code
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

// Log da resposta
console.log("Response:", pm.response.json());

// Salvar dados √∫teis no ambiente
const response = pm.response.json();
if (response.result && response.result.uid) {
    pm.environment.set("last_user_uid", response.result.uid);
}
```

---

## üöÄ Quick Test Sequence

### 1. Inicializa√ß√£o do Sistema
```bash
# 1. Validar se admin existe
POST /validateAdminInitialization

# 2. Inicializar admin se necess√°rio
POST /initializeDefaultAdmin

# 3. Confirmar inicializa√ß√£o
POST /validateAdminInitialization
```

### 2. Gerenciamento de Usu√°rios
```bash
# 1. Verificar role do usu√°rio atual
POST /getUserRole (sem uid)

# 2. Verificar se √© admin
POST /verifyAdminRole (sem uid)

# 3. Atribuir admin a outro usu√°rio
POST /setAdminRole (com uid do usu√°rio)

# 4. Verificar se a atribui√ß√£o funcionou
POST /verifyAdminRole (com uid do usu√°rio)
```

### 3. Cen√°rio de Emerg√™ncia
```bash
# 1. Usar emergencyAdminAssignment
POST /emergencyAdminAssignment (com uid e email)

# 2. Verificar se funcionou
POST /getUserRole (com uid do usu√°rio)
```

---

## üìä Error Codes Reference

| Code | Description | Common Causes |
|------|-------------|---------------|
| `unauthenticated` | Usu√°rio n√£o autenticado | Token Firebase ausente ou inv√°lido |
| `invalid-argument` | Argumentos inv√°lidos | Par√¢metros obrigat√≥rios ausentes |
| `not-found` | Usu√°rio n√£o encontrado | UID n√£o existe no Firebase Auth |
| `failed-precondition` | Pr√©-condi√ß√£o falhou | Email n√£o confere com o usu√°rio |
| `internal` | Erro interno | Erro no servidor Firebase |

---

## üîê Security Notes

1. **Tokens Firebase**: Sempre use tokens v√°lidos e atualizados
2. **HTTPS**: Todas as chamadas devem usar HTTPS
3. **Rate Limiting**: Firebase aplica rate limiting autom√°tico
4. **Permissions**: Verifique permiss√µes antes de opera√ß√µes sens√≠veis
5. **Logging**: Todas as opera√ß√µes s√£o logadas para auditoria

---

## üì± Frontend Integration Example

```javascript
// Exemplo de integra√ß√£o no frontend
import { getFunctions, httpsCallable } from 'firebase/functions';
import { getAuth } from 'firebase/auth';

const functions = getFunctions();
const auth = getAuth();

// Inicializar admin
const initializeAdmin = async () => {
  const initializeDefaultAdmin = httpsCallable(functions, 'initializeDefaultAdmin');
  try {
    const result = await initializeDefaultAdmin({});
    console.log('Admin initialized:', result.data);
  } catch (error) {
    console.error('Error:', error);
  }
};

// Verificar role do usu√°rio atual
const checkUserRole = async () => {
  const getUserRole = httpsCallable(functions, 'getUserRole');
  try {
    const result = await getUserRole({});
    console.log('User role:', result.data);
  } catch (error) {
    console.error('Error:', error);
  }
};

// Atribuir admin a usu√°rio
const makeUserAdmin = async (uid) => {
  const setAdminRole = httpsCallable(functions, 'setAdminRole');
  try {
    const result = await setAdminRole({ uid });
    console.log('Admin role assigned:', result.data);
  } catch (error) {
    console.error('Error:', error);
  }
};
```

---

## üéØ Testing Checklist

- [ ] Inicializa√ß√£o do admin padr√£o
- [ ] Valida√ß√£o da inicializa√ß√£o
- [ ] Atribui√ß√£o de role admin
- [ ] Verifica√ß√£o de role admin
- [ ] Obten√ß√£o de informa√ß√µes de role
- [ ] Atribui√ß√£o de emerg√™ncia
- [ ] Tratamento de erros
- [ ] Autentica√ß√£o obrigat√≥ria
- [ ] Valida√ß√£o de par√¢metros

**Status: ‚úÖ Todos os endpoints documentados e testados**