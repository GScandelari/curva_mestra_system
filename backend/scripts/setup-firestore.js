/**
 * Script para configurar Firestore em modo produ√ß√£o
 * 
 * Este script configura o Firestore com as cole√ß√µes necess√°rias,
 * √≠ndices compostos e configura√ß√µes de produ√ß√£o.
 */

const admin = require('firebase-admin');
const firebaseConfig = require('../src/config/firebase');

class FirestoreSetup {
  constructor() {
    this.db = null;
  }

  /**
   * Inicializar Firebase Admin SDK
   */
  async initialize() {
    try {
      firebaseConfig.initialize();
      this.db = firebaseConfig.getFirestore();
      console.log('Firebase Admin SDK inicializado com sucesso');
    } catch (error) {
      console.error('Erro ao inicializar Firebase:', error);
      throw error;
    }
  }

  /**
   * Criar estrutura b√°sica de cole√ß√µes para uma cl√≠nica
   */
  async createClinicStructure(clinicId, clinicData = {}) {
    console.log(`Criando estrutura para cl√≠nica: ${clinicId}`);
    
    try {
      // Criar documento da cl√≠nica
      const clinicDoc = {
        name: clinicData.name || 'Nova Cl√≠nica',
        address: clinicData.address || null,
        phone: clinicData.phone || null,
        email: clinicData.email || null,
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        isActive: true,
        settings: {
          timezone: 'America/Sao_Paulo',
          currency: 'BRL',
          language: 'pt-BR',
          notifications: {
            lowStock: true,
            expiring: true,
            requests: true
          }
        }
      };

      await this.db.doc(`clinics/${clinicId}`).set(clinicDoc);
      console.log(`‚úÖ Documento da cl√≠nica ${clinicId} criado`);

      // Criar cole√ß√µes vazias com documentos de exemplo (ser√£o removidos ap√≥s)
      const collections = [
        'users',
        'products', 
        'patients',
        'requests',
        'invoices',
        'stockMovements',
        'auditLogs',
        'notifications'
      ];

      for (const collection of collections) {
        const tempDoc = {
          _temp: true,
          createdAt: admin.firestore.FieldValue.serverTimestamp()
        };
        
        const docRef = await this.db.collection(`clinics/${clinicId}/${collection}`).add(tempDoc);
        await docRef.delete(); // Remove o documento tempor√°rio
        
        console.log(`‚úÖ Cole√ß√£o ${collection} inicializada`);
      }

      return clinicId;

    } catch (error) {
      console.error(`Erro ao criar estrutura da cl√≠nica ${clinicId}:`, error);
      throw error;
    }
  }

  /**
   * Configurar √≠ndices compostos programaticamente
   * Nota: Alguns √≠ndices podem precisar ser criados via Firebase Console
   */
  async setupIndexes() {
    console.log('Configurando √≠ndices compostos...');
    
    // Nota: A cria√ß√£o de √≠ndices via Admin SDK √© limitada
    // A maioria dos √≠ndices deve ser definida em firestore.indexes.json
    // Este m√©todo serve para documentar os √≠ndices necess√°rios
    
    const requiredIndexes = [
      {
        collection: 'products',
        fields: ['category', 'expirationDate'],
        description: 'Busca de produtos por categoria e data de vencimento'
      },
      {
        collection: 'products', 
        fields: ['currentStock', 'minimumStock'],
        description: 'Identifica√ß√£o de produtos com estoque baixo'
      },
      {
        collection: 'requests',
        fields: ['status', 'requestDate'],
        description: 'Listagem de solicita√ß√µes por status e data'
      },
      {
        collection: 'stockMovements',
        fields: ['productId', 'date'],
        description: 'Hist√≥rico de movimenta√ß√µes por produto'
      },
      {
        collection: 'notifications',
        fields: ['userId', 'isRead', 'createdAt'],
        description: 'Notifica√ß√µes n√£o lidas por usu√°rio'
      }
    ];

    console.log('üìã √çndices necess√°rios (definidos em firestore.indexes.json):');
    requiredIndexes.forEach((index, i) => {
      console.log(`${i + 1}. ${index.collection}: [${index.fields.join(', ')}] - ${index.description}`);
    });

    console.log('\n‚ö†Ô∏è Certifique-se de que os √≠ndices est√£o definidos em firestore.indexes.json');
    console.log('Execute: firebase deploy --only firestore:indexes');
  }

  /**
   * Criar usu√°rio administrador inicial
   */
  async createInitialAdmin(clinicId, adminData) {
    console.log('Criando usu√°rio administrador inicial...');
    
    try {
      // Criar usu√°rio no Firebase Auth
      const userRecord = await admin.auth().createUser({
        uid: adminData.uid || undefined,
        email: adminData.email,
        password: adminData.password,
        displayName: adminData.name,
        disabled: false
      });

      // Definir custom claims
      await admin.auth().setCustomUserClaims(userRecord.uid, {
        role: 'admin',
        clinicId: clinicId,
        permissions: ['all']
      });

      // Criar documento do usu√°rio no Firestore
      const userDoc = {
        name: adminData.name,
        email: adminData.email,
        role: 'admin',
        isActive: true,
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        lastLogin: null,
        permissions: ['all']
      };

      await this.db.doc(`clinics/${clinicId}/users/${userRecord.uid}`).set(userDoc);

      console.log(`‚úÖ Usu√°rio administrador criado: ${adminData.email} (${userRecord.uid})`);
      
      return userRecord.uid;

    } catch (error) {
      console.error('Erro ao criar usu√°rio administrador:', error);
      throw error;
    }
  }

  /**
   * Configurar regras de seguran√ßa (informativo)
   */
  async checkSecurityRules() {
    console.log('Verificando regras de seguran√ßa...');
    
    // Nota: As regras s√£o definidas em firestore.rules
    // Este m√©todo serve para validar se as regras est√£o ativas
    
    try {
      // Tentar uma opera√ß√£o que deve falhar sem autentica√ß√£o
      const testRef = this.db.doc('test/unauthorized');
      
      try {
        await testRef.get();
        console.log('‚ö†Ô∏è ATEN√á√ÉO: Regras de seguran√ßa podem n√£o estar ativas!');
        console.log('Execute: firebase deploy --only firestore:rules');
      } catch (error) {
        if (error.code === 'permission-denied') {
          console.log('‚úÖ Regras de seguran√ßa est√£o ativas');
        } else {
          console.log('‚ùì Status das regras de seguran√ßa indeterminado');
        }
      }
    } catch (error) {
      console.log('‚ùì N√£o foi poss√≠vel verificar regras de seguran√ßa');
    }
  }

  /**
   * Configurar triggers e fun√ß√µes de notifica√ß√£o
   */
  async setupTriggers() {
    console.log('Configurando triggers de notifica√ß√£o...');
    
    // Nota: Os triggers s√£o implementados como Firebase Functions
    // Este m√©todo serve para documentar os triggers necess√°rios
    
    const requiredTriggers = [
      {
        trigger: 'onCreate',
        collection: 'products',
        function: 'onProductCreate',
        description: 'Criar log de auditoria quando produto √© criado'
      },
      {
        trigger: 'onUpdate', 
        collection: 'products',
        function: 'onProductUpdate',
        description: 'Verificar estoque baixo e criar notifica√ß√µes'
      },
      {
        trigger: 'onWrite',
        collection: 'stockMovements', 
        function: 'onStockMovement',
        description: 'Atualizar estoque atual do produto'
      },
      {
        trigger: 'scheduled',
        schedule: '0 9 * * *',
        function: 'checkExpiringProducts',
        description: 'Verificar produtos vencendo diariamente'
      }
    ];

    console.log('üìã Triggers necess√°rios (implementar em Firebase Functions):');
    requiredTriggers.forEach((trigger, i) => {
      console.log(`${i + 1}. ${trigger.function}: ${trigger.trigger} ${trigger.collection || trigger.schedule} - ${trigger.description}`);
    });

    console.log('\n‚ö†Ô∏è Implemente estes triggers em functions/src/');
  }

  /**
   * Executar configura√ß√£o completa
   */
  async setup(options = {}) {
    console.log('üöÄ Iniciando configura√ß√£o do Firestore...\n');
    
    try {
      // Configurar cl√≠nica
      const clinicId = options.clinicId || 'default-clinic';
      const clinicData = options.clinicData || {};
      
      await this.createClinicStructure(clinicId, clinicData);
      
      // Criar admin inicial se fornecido
      if (options.adminData) {
        await this.createInitialAdmin(clinicId, options.adminData);
      }
      
      // Configurar √≠ndices
      await this.setupIndexes();
      
      // Verificar regras de seguran√ßa
      await this.checkSecurityRules();
      
      // Configurar triggers
      await this.setupTriggers();
      
      console.log('\nüéâ Configura√ß√£o do Firestore conclu√≠da com sucesso!');
      console.log('\nüìù Pr√≥ximos passos:');
      console.log('1. Execute: firebase deploy --only firestore:rules');
      console.log('2. Execute: firebase deploy --only firestore:indexes');
      console.log('3. Implemente as Firebase Functions necess√°rias');
      console.log('4. Execute os testes de seguran√ßa: node backend/scripts/test-firestore-rules.js');
      
      return {
        success: true,
        clinicId,
        message: 'Firestore configurado com sucesso'
      };

    } catch (error) {
      console.error('‚ùå Erro durante configura√ß√£o:', error);
      throw error;
    }
  }

  /**
   * Verificar status da configura√ß√£o
   */
  async checkStatus(clinicId = 'default-clinic') {
    console.log(`Verificando status da configura√ß√£o para cl√≠nica: ${clinicId}`);
    
    const status = {
      clinic: false,
      collections: {},
      admin: false,
      rules: 'unknown'
    };

    try {
      // Verificar documento da cl√≠nica
      const clinicDoc = await this.db.doc(`clinics/${clinicId}`).get();
      status.clinic = clinicDoc.exists;
      
      // Verificar cole√ß√µes
      const collections = ['users', 'products', 'patients', 'requests', 'invoices', 'stockMovements', 'auditLogs', 'notifications'];
      
      for (const collection of collections) {
        try {
          const snapshot = await this.db.collection(`clinics/${clinicId}/${collection}`).limit(1).get();
          status.collections[collection] = true;
        } catch (error) {
          status.collections[collection] = false;
        }
      }
      
      // Verificar se existe pelo menos um admin
      const adminQuery = await this.db.collection(`clinics/${clinicId}/users`)
        .where('role', '==', 'admin')
        .limit(1)
        .get();
      
      status.admin = !adminQuery.empty;
      
      console.log('üìä Status da Configura√ß√£o:');
      console.log(`Cl√≠nica: ${status.clinic ? '‚úÖ' : '‚ùå'}`);
      console.log(`Admin: ${status.admin ? '‚úÖ' : '‚ùå'}`);
      console.log('Cole√ß√µes:');
      
      Object.entries(status.collections).forEach(([collection, exists]) => {
        console.log(`  ${collection}: ${exists ? '‚úÖ' : '‚ùå'}`);
      });
      
      return status;

    } catch (error) {
      console.error('Erro ao verificar status:', error);
      throw error;
    }
  }
}

// Fun√ß√£o principal
async function main() {
  const setup = new FirestoreSetup();
  
  try {
    await setup.initialize();
    
    // Obter par√¢metros da linha de comando
    const args = process.argv.slice(2);
    const command = args[0] || 'setup';
    
    switch (command) {
      case 'setup':
        const clinicId = args[1] || 'default-clinic';
        const clinicName = args[2] || 'Nova Cl√≠nica';
        
        await setup.setup({
          clinicId,
          clinicData: { name: clinicName }
        });
        break;
        
      case 'create-admin':
        const adminClinicId = args[1] || 'default-clinic';
        const adminEmail = args[2];
        const adminPassword = args[3];
        const adminName = args[4] || 'Administrador';
        
        if (!adminEmail || !adminPassword) {
          console.error('‚ùå Email e senha s√£o obrigat√≥rios para criar admin');
          console.log('Uso: node setup-firestore.js create-admin <clinicId> <email> <password> [nome]');
          process.exit(1);
        }
        
        await setup.createInitialAdmin(adminClinicId, {
          email: adminEmail,
          password: adminPassword,
          name: adminName
        });
        break;
        
      case 'status':
        const statusClinicId = args[1] || 'default-clinic';
        await setup.checkStatus(statusClinicId);
        break;
        
      default:
        console.log('Comandos dispon√≠veis:');
        console.log('  setup [clinicId] [clinicName] - Configurar Firestore');
        console.log('  create-admin <clinicId> <email> <password> [nome] - Criar admin');
        console.log('  status [clinicId] - Verificar status');
        break;
    }
    
    process.exit(0);
    
  } catch (error) {
    console.error('‚ùå Erro:', error);
    process.exit(1);
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  main();
}

module.exports = FirestoreSetup;