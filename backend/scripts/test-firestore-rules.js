/**
 * Script para testar regras de seguran√ßa do Firestore
 * 
 * Este script usa o Firebase Rules Unit Testing para validar
 * as regras de seguran√ßa implementadas no Firestore.
 * 
 * NOTA: Este script requer que o Firebase Emulator esteja rodando.
 * Execute: firebase emulators:start --only firestore
 */

const { 
  initializeTestEnvironment,
  assertFails,
  assertSucceeds
} = require('@firebase/rules-unit-testing');
const fs = require('fs');
const path = require('path');

// Configura√ß√£o do projeto de teste
const PROJECT_ID = 'curva-mestra-test';
const RULES_FILE = path.join(__dirname, '../../firestore.rules');

// Dados de teste
const testData = {
  clinicId: 'test-clinic',
  userId: 'test-user-1',
  adminUserId: 'admin-user-1',
  doctorUserId: 'doctor-user-1',
  otherClinicId: 'other-clinic',
  otherUserId: 'other-user-1'
};

class FirestoreRulesTest {
  constructor() {
    this.testEnv = null;
  }

  /**
   * Configurar ambiente de teste
   */
  async setup() {
    try {
      // Carregar regras de seguran√ßa
      const rules = fs.readFileSync(RULES_FILE, 'utf8');
      
      // Inicializar ambiente de teste
      this.testEnv = await initializeTestEnvironment({
        projectId: PROJECT_ID,
        firestore: {
          rules: rules,
          host: 'localhost',
          port: 8080
        }
      });
      
      console.log('Ambiente de teste configurado');
    } catch (error) {
      console.error('Erro ao configurar ambiente de teste:', error.message);
      console.log('\n‚ö†Ô∏è Certifique-se de que o Firebase Emulator est√° rodando:');
      console.log('firebase emulators:start --only firestore');
      throw error;
    }
  }

  /**
   * Criar contexto de teste com autentica√ß√£o espec√≠fica
   */
  getTestContext(auth = null) {
    if (!this.testEnv) {
      throw new Error('Test environment not initialized');
    }
    
    if (auth) {
      return this.testEnv.authenticatedContext(auth.uid, auth.token);
    } else {
      return this.testEnv.unauthenticatedContext();
    }
  }

  /**
   * Executar teste e verificar resultado
   */
  async runTest(testName, testFn) {
    try {
      console.log(`\nüß™ Executando: ${testName}`);
      await testFn();
      console.log(`‚úÖ ${testName} - PASSOU`);
      return true;
    } catch (error) {
      console.log(`‚ùå ${testName} - FALHOU: ${error.message}`);
      return false;
    }
  }

  /**
   * Testes de autentica√ß√£o b√°sica
   */
  async testAuthentication() {
    const tests = [];

    // Teste 1: Usu√°rio n√£o autenticado n√£o pode acessar dados
    tests.push(await this.runTest(
      'Usu√°rio n√£o autenticado n√£o pode ler dados da cl√≠nica',
      async () => {
        const context = this.getTestContext(); // Sem auth
        const db = context.firestore();
        
        await assertFails(
          db.collection(`clinics/${testData.clinicId}/products`).get()
        );
      }
    ));

    // Teste 2: Usu√°rio autenticado pode acessar dados da pr√≥pria cl√≠nica
    tests.push(await this.runTest(
      'Usu√°rio autenticado pode ler dados da pr√≥pria cl√≠nica',
      async () => {
        const context = this.getTestContext({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = context.firestore();
        
        await assertSucceeds(
          db.collection(`clinics/${testData.clinicId}/products`).get()
        );
      }
    ));

    // Teste 3: Usu√°rio n√£o pode acessar dados de outra cl√≠nica
    tests.push(await this.runTest(
      'Usu√°rio n√£o pode acessar dados de outra cl√≠nica',
      async () => {
        const context = this.getTestContext({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = context.firestore();
        
        await assertFails(
          db.collection(`clinics/${testData.otherClinicId}/products`).get()
        );
      }
    ));

    return tests;
  }

  /**
   * Testes de permiss√µes por role
   */
  async testRolePermissions() {
    const tests = [];

    // Teste 1: Apenas admin pode criar usu√°rios
    tests.push(await this.runTest(
      'Apenas admin pode criar usu√°rios',
      async () => {
        // Receptionist n√£o pode criar usu√°rio
        const receptionistApp = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertFails(
          receptionistApp.firestore()
            .doc(`clinics/${testData.clinicId}/users/new-user`)
            .set({ name: 'Novo Usu√°rio', role: 'doctor' })
        );

        // Admin pode criar usu√°rio
        const adminApp = this.getTestApp({
          uid: testData.adminUserId,
          token: { 
            role: 'admin',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertSucceeds(
          adminApp.firestore()
            .doc(`clinics/${testData.clinicId}/users/new-user`)
            .set({ name: 'Novo Usu√°rio', role: 'doctor' })
        );
      }
    ));

    // Teste 2: Admin e manager podem criar produtos
    tests.push(await this.runTest(
      'Admin e manager podem criar produtos',
      async () => {
        // Receptionist n√£o pode criar produto
        const receptionistApp = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertFails(
          receptionistApp.firestore()
            .doc(`clinics/${testData.clinicId}/products/new-product`)
            .set({ name: 'Novo Produto', category: 'medicamento' })
        );

        // Manager pode criar produto
        const managerApp = this.getTestApp({
          uid: 'manager-user-1',
          token: { 
            role: 'manager',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertSucceeds(
          managerApp.firestore()
            .doc(`clinics/${testData.clinicId}/products/new-product`)
            .set({ name: 'Novo Produto', category: 'medicamento' })
        );
      }
    ));

    // Teste 3: Apenas doctors podem criar tratamentos
    tests.push(await this.runTest(
      'Apenas doctors e admins podem criar tratamentos',
      async () => {
        // Receptionist n√£o pode criar tratamento
        const receptionistApp = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertFails(
          receptionistApp.firestore()
            .doc(`clinics/${testData.clinicId}/patients/patient-1/treatments/treatment-1`)
            .set({ description: 'Tratamento teste', doctorId: testData.doctorUserId })
        );

        // Doctor pode criar tratamento
        const doctorApp = this.getTestApp({
          uid: testData.doctorUserId,
          token: { 
            role: 'doctor',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertSucceeds(
          doctorApp.firestore()
            .doc(`clinics/${testData.clinicId}/patients/patient-1/treatments/treatment-1`)
            .set({ description: 'Tratamento teste', doctorId: testData.doctorUserId })
        );
      }
    ));

    return tests;
  }

  /**
   * Testes de propriedade de dados
   */
  async testDataOwnership() {
    const tests = [];

    // Teste 1: Usu√°rio pode atualizar seus pr√≥prios dados
    tests.push(await this.runTest(
      'Usu√°rio pode atualizar seus pr√≥prios dados',
      async () => {
        const app = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = app.firestore();
        
        // Primeiro criar o usu√°rio
        await db.doc(`clinics/${testData.clinicId}/users/${testData.userId}`)
          .set({ name: 'Usu√°rio Teste', email: 'teste@teste.com' });
        
        // Usu√°rio pode atualizar seus pr√≥prios dados
        await firebase.assertSucceeds(
          db.doc(`clinics/${testData.clinicId}/users/${testData.userId}`)
            .update({ name: 'Nome Atualizado' })
        );
        
        // Usu√°rio n√£o pode atualizar dados de outro usu√°rio
        await firebase.assertFails(
          db.doc(`clinics/${testData.clinicId}/users/other-user`)
            .update({ name: 'Nome Atualizado' })
        );
      }
    ));

    // Teste 2: Usu√°rio pode modificar suas pr√≥prias solicita√ß√µes
    tests.push(await this.runTest(
      'Usu√°rio pode modificar suas pr√≥prias solicita√ß√µes',
      async () => {
        const app = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = app.firestore();
        
        // Criar solicita√ß√£o
        await db.doc(`clinics/${testData.clinicId}/requests/request-1`)
          .set({ 
            requesterId: testData.userId,
            status: 'pending',
            notes: 'Solicita√ß√£o teste'
          });
        
        // Usu√°rio pode atualizar sua pr√≥pria solicita√ß√£o
        await firebase.assertSucceeds(
          db.doc(`clinics/${testData.clinicId}/requests/request-1`)
            .update({ notes: 'Notas atualizadas' })
        );
        
        // Criar solicita√ß√£o de outro usu√°rio
        await db.doc(`clinics/${testData.clinicId}/requests/request-2`)
          .set({ 
            requesterId: 'other-user',
            status: 'pending',
            notes: 'Solicita√ß√£o de outro usu√°rio'
          });
        
        // Usu√°rio n√£o pode atualizar solicita√ß√£o de outro usu√°rio
        await firebase.assertFails(
          db.doc(`clinics/${testData.clinicId}/requests/request-2`)
            .update({ notes: 'Tentativa de atualiza√ß√£o' })
        );
      }
    ));

    return tests;
  }

  /**
   * Testes de logs de auditoria
   */
  async testAuditLogs() {
    const tests = [];

    // Teste 1: Apenas admins podem ler logs de auditoria
    tests.push(await this.runTest(
      'Apenas admins podem ler logs de auditoria',
      async () => {
        // Receptionist n√£o pode ler logs
        const receptionistApp = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertFails(
          receptionistApp.firestore()
            .collection(`clinics/${testData.clinicId}/auditLogs`)
            .get()
        );

        // Admin pode ler logs
        const adminApp = this.getTestApp({
          uid: testData.adminUserId,
          token: { 
            role: 'admin',
            clinicId: testData.clinicId
          }
        });
        
        await firebase.assertSucceeds(
          adminApp.firestore()
            .collection(`clinics/${testData.clinicId}/auditLogs`)
            .get()
        );
      }
    ));

    // Teste 2: Logs n√£o podem ser modificados ou deletados
    tests.push(await this.runTest(
      'Logs n√£o podem ser modificados ou deletados',
      async () => {
        const adminApp = this.getTestApp({
          uid: testData.adminUserId,
          token: { 
            role: 'admin',
            clinicId: testData.clinicId
          }
        });
        const db = adminApp.firestore();
        
        // Tentar atualizar log (deve falhar)
        await firebase.assertFails(
          db.doc(`clinics/${testData.clinicId}/auditLogs/log-1`)
            .update({ action: 'modified' })
        );
        
        // Tentar deletar log (deve falhar)
        await firebase.assertFails(
          db.doc(`clinics/${testData.clinicId}/auditLogs/log-1`)
            .delete()
        );
      }
    ));

    return tests;
  }

  /**
   * Testes de notifica√ß√µes
   */
  async testNotifications() {
    const tests = [];

    // Teste 1: Usu√°rio pode ler apenas suas pr√≥prias notifica√ß√µes
    tests.push(await this.runTest(
      'Usu√°rio pode ler apenas suas pr√≥prias notifica√ß√µes',
      async () => {
        const app = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = app.firestore();
        
        // Criar notifica√ß√£o do usu√°rio
        await db.doc(`clinics/${testData.clinicId}/notifications/notif-1`)
          .set({ 
            userId: testData.userId,
            message: 'Notifica√ß√£o do usu√°rio',
            isRead: false
          });
        
        // Usu√°rio pode ler sua pr√≥pria notifica√ß√£o
        await firebase.assertSucceeds(
          db.doc(`clinics/${testData.clinicId}/notifications/notif-1`).get()
        );
        
        // Criar notifica√ß√£o de outro usu√°rio
        await db.doc(`clinics/${testData.clinicId}/notifications/notif-2`)
          .set({ 
            userId: 'other-user',
            message: 'Notifica√ß√£o de outro usu√°rio',
            isRead: false
          });
        
        // Usu√°rio n√£o pode ler notifica√ß√£o de outro usu√°rio
        await firebase.assertFails(
          db.doc(`clinics/${testData.clinicId}/notifications/notif-2`).get()
        );
      }
    ));

    // Teste 2: Usu√°rio pode marcar suas notifica√ß√µes como lidas
    tests.push(await this.runTest(
      'Usu√°rio pode marcar suas notifica√ß√µes como lidas',
      async () => {
        const app = this.getTestApp({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = app.firestore();
        
        // Criar notifica√ß√£o
        await db.doc(`clinics/${testData.clinicId}/notifications/notif-3`)
          .set({ 
            userId: testData.userId,
            message: 'Notifica√ß√£o para marcar como lida',
            isRead: false
          });
        
        // Usu√°rio pode marcar como lida
        await firebase.assertSucceeds(
          db.doc(`clinics/${testData.clinicId}/notifications/notif-3`)
            .update({ isRead: true })
        );
        
        // Usu√°rio n√£o pode modificar outros campos
        await firebase.assertFails(
          db.doc(`clinics/${testData.clinicId}/notifications/notif-3`)
            .update({ message: 'Mensagem modificada' })
        );
      }
    ));

    return tests;
  }

  /**
   * Executar todos os testes
   */
  async runAllTests() {
    console.log('üöÄ Iniciando testes das regras de seguran√ßa do Firestore\n');
    
    await this.setup();
    
    const allTests = [];
    
    // Executar grupos de testes
    allTests.push(...await this.testAuthentication());
    allTests.push(...await this.testRolePermissions());
    allTests.push(...await this.testDataOwnership());
    allTests.push(...await this.testAuditLogs());
    allTests.push(...await this.testNotifications());
    
    // Calcular resultados
    const passed = allTests.filter(result => result).length;
    const failed = allTests.length - passed;
    
    console.log('\nüìä Resultados dos Testes:');
    console.log(`‚úÖ Passou: ${passed}`);
    console.log(`‚ùå Falhou: ${failed}`);
    console.log(`üìà Taxa de Sucesso: ${((passed / allTests.length) * 100).toFixed(1)}%`);
    
    if (failed === 0) {
      console.log('\nüéâ Todos os testes passaram! As regras de seguran√ßa est√£o funcionando corretamente.');
    } else {
      console.log('\n‚ö†Ô∏è Alguns testes falharam. Revise as regras de seguran√ßa.');
    }
    
    return { passed, failed, total: allTests.length };
  }

  /**
   * Limpar recursos de teste
   */
  async cleanup() {
    if (this.testEnv) {
      await this.testEnv.cleanup();
      console.log('\nüßπ Limpeza conclu√≠da');
    }
  }
}

// Fun√ß√£o principal
async function main() {
  const tester = new FirestoreRulesTest();
  
  try {
    const results = await tester.runAllTests();
    
    // Retornar c√≥digo de sa√≠da baseado nos resultados
    process.exit(results.failed > 0 ? 1 : 0);
    
  } catch (error) {
    console.error('‚ùå Erro durante execu√ß√£o dos testes:', error);
    process.exit(1);
  } finally {
    await tester.cleanup();
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  main();
}

module.exports = FirestoreRulesTest;