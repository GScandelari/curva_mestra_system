/**
 * Script simplificado para testar regras de seguran√ßa do Firestore
 * 
 * NOTA: Este script requer que o Firebase Emulator esteja rodando.
 * Execute: firebase emulators:start --only firestore
 */

const { 
  initializeTestEnvironment,
  assertFails,
  assertSucceeds
} = require('@firebase/rules-unit-testing');
const fs = require('fs');
const path = require('path');

// Configura√ß√£o do projeto de teste
const PROJECT_ID = 'curva-mestra-test';
const RULES_FILE = path.join(__dirname, '../../firestore.rules');

// Dados de teste
const testData = {
  clinicId: 'test-clinic',
  userId: 'test-user-1',
  adminUserId: 'admin-user-1',
  otherClinicId: 'other-clinic'
};

class SimpleFirestoreRulesTest {
  constructor() {
    this.testEnv = null;
  }

  async setup() {
    try {
      const rules = fs.readFileSync(RULES_FILE, 'utf8');
      
      this.testEnv = await initializeTestEnvironment({
        projectId: PROJECT_ID,
        firestore: {
          rules: rules,
          host: 'localhost',
          port: 8080
        }
      });
      
      console.log('‚úÖ Ambiente de teste configurado');
    } catch (error) {
      console.error('‚ùå Erro ao configurar ambiente de teste:', error.message);
      console.log('\n‚ö†Ô∏è Certifique-se de que o Firebase Emulator est√° rodando:');
      console.log('firebase emulators:start --only firestore');
      throw error;
    }
  }

  getContext(auth = null) {
    if (!this.testEnv) {
      throw new Error('Test environment not initialized');
    }
    
    if (auth) {
      return this.testEnv.authenticatedContext(auth.uid, auth.token);
    } else {
      return this.testEnv.unauthenticatedContext();
    }
  }

  async runTest(testName, testFn) {
    try {
      console.log(`\nüß™ ${testName}`);
      await testFn();
      console.log(`‚úÖ PASSOU`);
      return true;
    } catch (error) {
      console.log(`‚ùå FALHOU: ${error.message}`);
      return false;
    }
  }

  async runBasicTests() {
    const results = [];

    // Teste 1: Usu√°rio n√£o autenticado n√£o pode acessar dados
    results.push(await this.runTest(
      'Usu√°rio n√£o autenticado n√£o pode ler dados da cl√≠nica',
      async () => {
        const context = this.getContext(); // Sem auth
        const db = context.firestore();
        
        await assertFails(
          db.collection(`clinics/${testData.clinicId}/products`).get()
        );
      }
    ));

    // Teste 2: Usu√°rio autenticado pode acessar dados da pr√≥pria cl√≠nica
    results.push(await this.runTest(
      'Usu√°rio autenticado pode ler dados da pr√≥pria cl√≠nica',
      async () => {
        const context = this.getContext({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = context.firestore();
        
        await assertSucceeds(
          db.collection(`clinics/${testData.clinicId}/products`).get()
        );
      }
    ));

    // Teste 3: Usu√°rio n√£o pode acessar dados de outra cl√≠nica
    results.push(await this.runTest(
      'Usu√°rio n√£o pode acessar dados de outra cl√≠nica',
      async () => {
        const context = this.getContext({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        const db = context.firestore();
        
        await assertFails(
          db.collection(`clinics/${testData.otherClinicId}/products`).get()
        );
      }
    ));

    // Teste 4: Apenas admin pode criar usu√°rios
    results.push(await this.runTest(
      'Apenas admin pode criar usu√°rios',
      async () => {
        // Receptionist n√£o pode criar usu√°rio
        const receptionistContext = this.getContext({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        
        await assertFails(
          receptionistContext.firestore()
            .doc(`clinics/${testData.clinicId}/users/new-user`)
            .set({ name: 'Novo Usu√°rio', role: 'doctor' })
        );

        // Admin pode criar usu√°rio
        const adminContext = this.getContext({
          uid: testData.adminUserId,
          token: { 
            role: 'admin',
            clinicId: testData.clinicId
          }
        });
        
        await assertSucceeds(
          adminContext.firestore()
            .doc(`clinics/${testData.clinicId}/users/new-user`)
            .set({ name: 'Novo Usu√°rio', role: 'doctor' })
        );
      }
    ));

    // Teste 5: Admin e manager podem criar produtos
    results.push(await this.runTest(
      'Admin e manager podem criar produtos',
      async () => {
        // Receptionist n√£o pode criar produto
        const receptionistContext = this.getContext({
          uid: testData.userId,
          token: { 
            role: 'receptionist',
            clinicId: testData.clinicId
          }
        });
        
        await assertFails(
          receptionistContext.firestore()
            .doc(`clinics/${testData.clinicId}/products/new-product`)
            .set({ name: 'Novo Produto', category: 'medicamento' })
        );

        // Manager pode criar produto
        const managerContext = this.getContext({
          uid: 'manager-user-1',
          token: { 
            role: 'manager',
            clinicId: testData.clinicId
          }
        });
        
        await assertSucceeds(
          managerContext.firestore()
            .doc(`clinics/${testData.clinicId}/products/new-product`)
            .set({ name: 'Novo Produto', category: 'medicamento' })
        );
      }
    ));

    return results;
  }

  async runAllTests() {
    console.log('üöÄ Iniciando testes das regras de seguran√ßa do Firestore\n');
    
    await this.setup();
    
    const results = await this.runBasicTests();
    
    // Calcular resultados
    const passed = results.filter(result => result).length;
    const failed = results.length - passed;
    
    console.log('\nüìä Resultados dos Testes:');
    console.log(`‚úÖ Passou: ${passed}`);
    console.log(`‚ùå Falhou: ${failed}`);
    console.log(`üìà Taxa de Sucesso: ${((passed / results.length) * 100).toFixed(1)}%`);
    
    if (failed === 0) {
      console.log('\nüéâ Todos os testes passaram! As regras de seguran√ßa est√£o funcionando corretamente.');
    } else {
      console.log('\n‚ö†Ô∏è Alguns testes falharam. Revise as regras de seguran√ßa.');
    }
    
    return { passed, failed, total: results.length };
  }

  async cleanup() {
    if (this.testEnv) {
      await this.testEnv.cleanup();
      console.log('\nüßπ Limpeza conclu√≠da');
    }
  }
}

// Fun√ß√£o principal
async function main() {
  const tester = new SimpleFirestoreRulesTest();
  
  try {
    const results = await tester.runAllTests();
    
    // Retornar c√≥digo de sa√≠da baseado nos resultados
    process.exit(results.failed > 0 ? 1 : 0);
    
  } catch (error) {
    console.error('‚ùå Erro durante execu√ß√£o dos testes:', error);
    process.exit(1);
  } finally {
    await tester.cleanup();
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  main();
}

module.exports = SimpleFirestoreRulesTest;