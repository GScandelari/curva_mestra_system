#!/usr/bin/env node

const axios = require('axios');
const admin = require('firebase-admin');
const { getAuth } = require('firebase-admin/auth');

/**
 * Script para testar a API Admin com tokens v√°lidos
 */

const BASE_URL = 'https://us-central1-curva-mestra.cloudfunctions.net';
const ADMIN_UID = 'gEjUSOsHF9QmS0Dvi0zB10GsxrD2';

// Inicializar Firebase Admin
if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'curva-mestra'
  });
}

class APITester {
  constructor() {
    this.token = null;
  }

  async generateToken(uid) {
    try {
      console.log(`üîë Gerando token para UID: ${uid}`);
      this.token = await getAuth().createCustomToken(uid);
      console.log(`‚úÖ Token gerado com sucesso`);
      return this.token;
    } catch (error) {
      console.error('‚ùå Erro ao gerar token:', error.message);
      throw error;
    }
  }

  async callAPI(endpoint, data = {}, requireAuth = true) {
    const url = `${BASE_URL}/${endpoint}`;
    const headers = {
      'Content-Type': 'application/json'
    };

    if (requireAuth && this.token) {
      headers['Authorization'] = `Bearer ${this.token}`;
    }

    const payload = { data };

    try {
      console.log(`\nüöÄ Chamando: ${endpoint}`);
      console.log(`üì§ Payload:`, JSON.stringify(payload, null, 2));
      
      const response = await axios.post(url, payload, { headers });
      
      console.log(`‚úÖ Sucesso (${response.status})`);
      console.log(`üì• Resposta:`, JSON.stringify(response.data, null, 2));
      
      return response.data;
    } catch (error) {
      console.error(`‚ùå Erro em ${endpoint}:`);
      if (error.response) {
        console.error(`Status: ${error.response.status}`);
        console.error(`Resposta:`, JSON.stringify(error.response.data, null, 2));
      } else {
        console.error(`Erro:`, error.message);
      }
      throw error;
    }
  }

  async testInitialization() {
    console.log('\nüîß === TESTE DE INICIALIZA√á√ÉO ===');
    
    try {
      // 1. Validar inicializa√ß√£o (sem auth)
      await this.callAPI('validateAdminInitialization', {}, false);
      
      // 2. Inicializar admin (sem auth)
      await this.callAPI('initializeDefaultAdmin', {}, false);
      
      // 3. Validar novamente
      await this.callAPI('validateAdminInitialization', {}, false);
      
      console.log('‚úÖ Teste de inicializa√ß√£o conclu√≠do');
    } catch (error) {
      console.error('‚ùå Falha no teste de inicializa√ß√£o');
    }
  }

  async testUserManagement() {
    console.log('\nüë• === TESTE DE GERENCIAMENTO DE USU√ÅRIOS ===');
    
    try {
      // Gerar token para o admin
      await this.generateToken(ADMIN_UID);
      
      // 1. Obter role do usu√°rio atual
      await this.callAPI('getUserRole', {});
      
      // 2. Verificar se √© admin
      await this.callAPI('verifyAdminRole', {});
      
      // 3. Definir role admin para o pr√≥prio usu√°rio (teste)
      await this.callAPI('setAdminRole', { uid: ADMIN_UID });
      
      // 4. Verificar novamente
      await this.callAPI('verifyAdminRole', { uid: ADMIN_UID });
      
      console.log('‚úÖ Teste de gerenciamento de usu√°rios conclu√≠do');
    } catch (error) {
      console.error('‚ùå Falha no teste de gerenciamento de usu√°rios');
    }
  }

  async testEmergencyAssignment() {
    console.log('\nüö® === TESTE DE ATRIBUI√á√ÉO DE EMERG√äNCIA ===');
    
    try {
      // Gerar token para o admin
      await this.generateToken(ADMIN_UID);
      
      // Criar usu√°rio de teste se n√£o existir
      let testUser;
      try {
        testUser = await getAuth().getUserByEmail('test@curva-mestra.com');
      } catch (error) {
        if (error.code === 'auth/user-not-found') {
          testUser = await getAuth().createUser({
            email: 'test@curva-mestra.com',
            password: 'testpassword123',
            displayName: 'Test User'
          });
          console.log(`üë§ Usu√°rio de teste criado: ${testUser.uid}`);
        }
      }
      
      // Atribui√ß√£o de emerg√™ncia
      await this.callAPI('emergencyAdminAssignment', {
        uid: testUser.uid,
        email: testUser.email
      });
      
      // Verificar se funcionou
      await this.callAPI('getUserRole', { uid: testUser.uid });
      
      console.log('‚úÖ Teste de atribui√ß√£o de emerg√™ncia conclu√≠do');
    } catch (error) {
      console.error('‚ùå Falha no teste de atribui√ß√£o de emerg√™ncia');
    }
  }

  async generateCurlExamples() {
    console.log('\nüìã === EXEMPLOS DE CURL ===');
    
    try {
      const token = await this.generateToken(ADMIN_UID);
      
      console.log(`
üîê Token gerado: ${token}

üìã Exemplos de curl com token v√°lido:

1Ô∏è‚É£ Inicializar Admin (sem auth):
curl --location '${BASE_URL}/initializeDefaultAdmin' \\
--header 'Content-Type: application/json' \\
--data '{"data": {}}'

2Ô∏è‚É£ Validar Inicializa√ß√£o (sem auth):
curl --location '${BASE_URL}/validateAdminInitialization' \\
--header 'Content-Type: application/json' \\
--data '{"data": {}}'

3Ô∏è‚É£ Obter Role do Usu√°rio (com auth):
curl --location '${BASE_URL}/getUserRole' \\
--header 'Content-Type: application/json' \\
--header 'Authorization: Bearer ${token}' \\
--data '{"data": {}}'

4Ô∏è‚É£ Verificar Admin (com auth):
curl --location '${BASE_URL}/verifyAdminRole' \\
--header 'Content-Type: application/json' \\
--header 'Authorization: Bearer ${token}' \\
--data '{"data": {}}'

5Ô∏è‚É£ Definir Admin Role (com auth):
curl --location '${BASE_URL}/setAdminRole' \\
--header 'Content-Type: application/json' \\
--header 'Authorization: Bearer ${token}' \\
--data '{"data": {"uid": "${ADMIN_UID}"}}'

6Ô∏è‚É£ Atribui√ß√£o de Emerg√™ncia (com auth):
curl --location '${BASE_URL}/emergencyAdminAssignment' \\
--header 'Content-Type: application/json' \\
--header 'Authorization: Bearer ${token}' \\
--data '{"data": {"uid": "test-user-uid", "email": "test@example.com"}}'
      `);
      
    } catch (error) {
      console.error('‚ùå Erro ao gerar exemplos de curl');
    }
  }

  async runAllTests() {
    console.log('üß™ === INICIANDO TESTES DA API ADMIN ===');
    
    try {
      await this.testInitialization();
      await this.testUserManagement();
      await this.testEmergencyAssignment();
      await this.generateCurlExamples();
      
      console.log('\nüéâ === TODOS OS TESTES CONCLU√çDOS ===');
    } catch (error) {
      console.error('\nüí• === ERRO NOS TESTES ===');
      console.error(error.message);
    }
  }
}

async function main() {
  const args = process.argv.slice(2);
  const command = args[0];
  
  const tester = new APITester();
  
  try {
    switch (command) {
      case 'init':
        await tester.testInitialization();
        break;
        
      case 'user':
        await tester.testUserManagement();
        break;
        
      case 'emergency':
        await tester.testEmergencyAssignment();
        break;
        
      case 'curl':
        await tester.generateCurlExamples();
        break;
        
      case 'all':
      default:
        await tester.runAllTests();
        break;
    }
  } catch (error) {
    console.error('üí• Erro na execu√ß√£o:', error.message);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = APITester;