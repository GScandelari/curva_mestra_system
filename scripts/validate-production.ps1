# Production Validation Script
# This script validates that all production services are working correctly

param(
    [string]$ProjectId = "curva-mestra",
    [string]$FrontendUrl = "https://curva-mestra.web.app",
    [string]$FunctionsUrl = "https://us-central1-curva-mestra.cloudfunctions.net",
    [switch]$Verbose = $false
)

Write-Host "üîç Validando deploy de produ√ß√£o" -ForegroundColor Green
Write-Host "===============================" -ForegroundColor Cyan

$validationResults = @{
    Frontend = $false
    Functions = $false
    Firestore = $false
    Authentication = $false
    Monitoring = $false
    Overall = $false
}

try {
    # Test 1: Frontend Accessibility
    Write-Host "`nüåê Teste 1: Acessibilidade do Frontend" -ForegroundColor Cyan
    Write-Host "=====================================" -ForegroundColor Cyan
    
    try {
        Write-Host "üîç Testando: $FrontendUrl" -ForegroundColor Yellow
        $frontendResponse = Invoke-WebRequest -Uri $FrontendUrl -Method HEAD -TimeoutSec 10
        
        if ($frontendResponse.StatusCode -eq 200) {
            Write-Host "‚úÖ Frontend acess√≠vel (Status: $($frontendResponse.StatusCode))" -ForegroundColor Green
            $validationResults.Frontend = $true
            
            # Check security headers
            $headers = $frontendResponse.Headers
            if ($headers['X-Content-Type-Options']) {
                Write-Host "‚úÖ Security headers configurados" -ForegroundColor Green
            } else {
                Write-Host "‚ö†Ô∏è Security headers podem estar ausentes" -ForegroundColor Yellow
            }
        }
    } catch {
        Write-Host "‚ùå Frontend n√£o acess√≠vel: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    # Test 2: Health Check Endpoint
    Write-Host "`n‚ö° Teste 2: Health Check das Functions" -ForegroundColor Cyan
    Write-Host "====================================" -ForegroundColor Cyan
    
    try {
        $healthUrl = "$FunctionsUrl/healthCheck"
        Write-Host "üîç Testando: $healthUrl" -ForegroundColor Yellow
        
        $healthResponse = Invoke-RestMethod -Uri $healthUrl -Method GET -TimeoutSec 15
        
        if ($healthResponse.status -eq "healthy") {
            Write-Host "‚úÖ Functions saud√°veis" -ForegroundColor Green
            $validationResults.Functions = $true
            
            if ($Verbose) {
                Write-Host "üìä Detalhes do health check:" -ForegroundColor Gray
                $healthResponse | ConvertTo-Json -Depth 3 | Write-Host -ForegroundColor Gray
            }
        } else {
            Write-Host "‚ö†Ô∏è Functions com status: $($healthResponse.status)" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "‚ùå Health check falhou: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    # Test 3: Firebase Services via CLI
    Write-Host "`nüî• Teste 3: Servi√ßos Firebase" -ForegroundColor Cyan
    Write-Host "============================" -ForegroundColor Cyan
    
    # Test Firestore
    Write-Host "üîç Testando Firestore..." -ForegroundColor Yellow
    try {
        $firestoreTest = firebase firestore:rules:get --project $ProjectId 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Firestore configurado e acess√≠vel" -ForegroundColor Green
            $validationResults.Firestore = $true
        } else {
            Write-Host "‚ùå Problema com Firestore: $firestoreTest" -ForegroundColor Red
        }
    } catch {
        Write-Host "‚ùå Erro ao testar Firestore: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    # Test Authentication
    Write-Host "üîç Testando Firebase Auth..." -ForegroundColor Yellow
    try {
        $authTest = firebase auth:export /dev/null --project $ProjectId 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Firebase Auth configurado e acess√≠vel" -ForegroundColor Green
            $validationResults.Authentication = $true
        } else {
            Write-Host "‚ùå Problema com Firebase Auth" -ForegroundColor Red
        }
    } catch {
        Write-Host "‚ùå Erro ao testar Firebase Auth: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    # Test 4: API Endpoints
    Write-Host "`nüîå Teste 4: Endpoints da API" -ForegroundColor Cyan
    Write-Host "===========================" -ForegroundColor Cyan
    
    $apiEndpoints = @(
        "/api/products",
        "/api/requests", 
        "/api/patients",
        "/api/invoices"
    )
    
    $apiResults = @{}
    
    foreach ($endpoint in $apiEndpoints) {
        try {
            $apiUrl = "$FunctionsUrl$endpoint"
            Write-Host "üîç Testando: $endpoint" -ForegroundColor Yellow
            
            # Test with OPTIONS method to check CORS
            $apiResponse = Invoke-WebRequest -Uri $apiUrl -Method OPTIONS -TimeoutSec 10
            
            if ($apiResponse.StatusCode -eq 200 -or $apiResponse.StatusCode -eq 204) {
                Write-Host "‚úÖ $endpoint - CORS configurado" -ForegroundColor Green
                $apiResults[$endpoint] = $true
            } else {
                Write-Host "‚ö†Ô∏è $endpoint - Status: $($apiResponse.StatusCode)" -ForegroundColor Yellow
                $apiResults[$endpoint] = $false
            }
        } catch {
            Write-Host "‚ùå $endpoint - Erro: $($_.Exception.Message)" -ForegroundColor Red
            $apiResults[$endpoint] = $false
        }
    }
    
    # Test 5: Monitoring and Analytics
    Write-Host "`nüìä Teste 5: Monitoramento" -ForegroundColor Cyan
    Write-Host "========================" -ForegroundColor Cyan
    
    try {
        # Check if monitoring functions are deployed
        Write-Host "üîç Verificando fun√ß√µes de monitoramento..." -ForegroundColor Yellow
        
        $functionsListOutput = firebase functions:list --project $ProjectId 2>&1
        
        $monitoringFunctions = @("reportError", "monitorCosts", "healthCheck")
        $deployedFunctions = @()
        
        foreach ($func in $monitoringFunctions) {
            if ($functionsListOutput -match $func) {
                $deployedFunctions += $func
                Write-Host "‚úÖ Fun√ß√£o $func deployada" -ForegroundColor Green
            } else {
                Write-Host "‚ö†Ô∏è Fun√ß√£o $func n√£o encontrada" -ForegroundColor Yellow
            }
        }
        
        if ($deployedFunctions.Count -ge 2) {
            $validationResults.Monitoring = $true
            Write-Host "‚úÖ Monitoramento configurado" -ForegroundColor Green
        } else {
            Write-Host "‚ö†Ô∏è Monitoramento parcialmente configurado" -ForegroundColor Yellow
        }
        
    } catch {
        Write-Host "‚ùå Erro ao verificar monitoramento: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    # Test 6: Performance Check
    Write-Host "`n‚ö° Teste 6: Performance" -ForegroundColor Cyan
    Write-Host "=====================" -ForegroundColor Cyan
    
    try {
        Write-Host "üîç Medindo tempo de resposta do frontend..." -ForegroundColor Yellow
        
        $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
        $performanceResponse = Invoke-WebRequest -Uri $FrontendUrl -Method GET -TimeoutSec 30
        $stopwatch.Stop()
        
        $responseTime = $stopwatch.ElapsedMilliseconds
        
        if ($responseTime -lt 3000) {
            Write-Host "‚úÖ Tempo de resposta: ${responseTime}ms (Bom)" -ForegroundColor Green
        } elseif ($responseTime -lt 5000) {
            Write-Host "‚ö†Ô∏è Tempo de resposta: ${responseTime}ms (Aceit√°vel)" -ForegroundColor Yellow
        } else {
            Write-Host "‚ùå Tempo de resposta: ${responseTime}ms (Lento)" -ForegroundColor Red
        }
        
        # Check content size
        $contentLength = $performanceResponse.Headers['Content-Length']
        if ($contentLength) {
            $sizeKB = [math]::Round($contentLength / 1024, 2)
            Write-Host "üìä Tamanho da p√°gina: ${sizeKB}KB" -ForegroundColor Gray
        }
        
    } catch {
        Write-Host "‚ùå Erro no teste de performance: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    # Calculate overall result
    $passedTests = ($validationResults.Values | Where-Object { $_ -eq $true }).Count
    $totalTests = $validationResults.Count - 1 # Exclude Overall
    
    if ($passedTests -ge ($totalTests * 0.8)) {
        $validationResults.Overall = $true
    }
    
    # Final Results
    Write-Host "`nüìã RESULTADOS DA VALIDA√á√ÉO" -ForegroundColor Cyan
    Write-Host "==========================" -ForegroundColor Cyan
    
    foreach ($test in $validationResults.GetEnumerator()) {
        if ($test.Key -eq "Overall") { continue }
        
        $status = if ($test.Value) { "‚úÖ PASSOU" } else { "‚ùå FALHOU" }
        $color = if ($test.Value) { "Green" } else { "Red" }
        
        Write-Host "$($test.Key): $status" -ForegroundColor $color
    }
    
    Write-Host "`nüìä Resumo: $passedTests/$totalTests testes passaram" -ForegroundColor Cyan
    
    if ($validationResults.Overall) {
        Write-Host "`nüéâ VALIDA√á√ÉO GERAL: SUCESSO" -ForegroundColor Green
        Write-Host "O sistema est√° funcionando corretamente em produ√ß√£o!" -ForegroundColor Green
    } else {
        Write-Host "`n‚ö†Ô∏è VALIDA√á√ÉO GERAL: ATEN√á√ÉO NECESS√ÅRIA" -ForegroundColor Yellow
        Write-Host "Alguns componentes precisam de aten√ß√£o." -ForegroundColor Yellow
    }
    
    # Recommendations
    Write-Host "`nüí° Recomenda√ß√µes:" -ForegroundColor Cyan
    
    if (-not $validationResults.Frontend) {
        Write-Host "- Verificar configura√ß√£o do Firebase Hosting" -ForegroundColor White
    }
    
    if (-not $validationResults.Functions) {
        Write-Host "- Verificar deploy das Firebase Functions" -ForegroundColor White
    }
    
    if (-not $validationResults.Firestore) {
        Write-Host "- Verificar configura√ß√£o do Firestore" -ForegroundColor White
    }
    
    if (-not $validationResults.Authentication) {
        Write-Host "- Verificar configura√ß√£o do Firebase Auth" -ForegroundColor White
    }
    
    if (-not $validationResults.Monitoring) {
        Write-Host "- Executar deploy das fun√ß√µes de monitoramento" -ForegroundColor White
    }
    
    Write-Host "`nüîó Links √öteis:" -ForegroundColor Cyan
    Write-Host "- Firebase Console: https://console.firebase.google.com/project/$ProjectId" -ForegroundColor White
    Write-Host "- Frontend: $FrontendUrl" -ForegroundColor White
    Write-Host "- Health Check: $FunctionsUrl/healthCheck" -ForegroundColor White
    
} catch {
    Write-Host "‚ùå Erro durante valida√ß√£o: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# Exit with appropriate code
if ($validationResults.Overall) {
    exit 0
} else {
    exit 1
}