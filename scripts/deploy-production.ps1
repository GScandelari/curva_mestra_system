# Production Deployment Script for Firebase Migration
# This script handles complete production deployment including Functions and Hosting

param(
    [switch]$SkipBuild = $false,
    [switch]$SkipTests = $false,
    [switch]$Force = $false
)

Write-Host "üöÄ Iniciando deploy de produ√ß√£o completo para Firebase" -ForegroundColor Green
Write-Host "=================================================" -ForegroundColor Cyan

# Set working directory to project root
$ProjectRoot = Split-Path -Parent $PSScriptRoot
Set-Location $ProjectRoot

# Configuration
$ProjectId = "curva-mestra"
$FrontendUrl = "https://curva-mestra.web.app"
$FunctionsUrl = "https://us-central1-curva-mestra.cloudfunctions.net"

try {
    # Pre-deployment checks
    Write-Host "üîç Executando verifica√ß√µes pr√©-deploy..." -ForegroundColor Yellow
    
    # Check Firebase CLI
    if (-not (Get-Command firebase -ErrorAction SilentlyContinue)) {
        Write-Host "‚ùå Firebase CLI n√£o encontrado. Instalando..." -ForegroundColor Red
        npm install -g firebase-tools
    }
    
    # Check authentication
    Write-Host "üîê Verificando autentica√ß√£o Firebase..." -ForegroundColor Yellow
    $loginCheck = firebase projects:list 2>&1
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå N√£o autenticado no Firebase. Execute: firebase login" -ForegroundColor Red
        exit 1
    }
    
    # Verify project exists
    Write-Host "üìã Verificando projeto Firebase..." -ForegroundColor Yellow
    $projectCheck = firebase projects:list | Select-String $ProjectId
    if (-not $projectCheck) {
        Write-Host "‚ùå Projeto $ProjectId n√£o encontrado" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "‚úÖ Verifica√ß√µes pr√©-deploy conclu√≠das" -ForegroundColor Green
    
    # Step 1: Deploy Firebase Functions
    Write-Host "`nüîß Passo 1: Deploy das Firebase Functions" -ForegroundColor Cyan
    Write-Host "=========================================" -ForegroundColor Cyan
    
    Set-Location functions
    
    if (-not $SkipBuild) {
        # Install dependencies
        Write-Host "üì¶ Instalando depend√™ncias das Functions..." -ForegroundColor Yellow
        npm ci
        
        # Build Functions
        Write-Host "üèóÔ∏è Construindo Functions..." -ForegroundColor Yellow
        npm run build
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Falha no build das Functions" -ForegroundColor Red
            exit 1
        }
    }
    
    # Run tests if not skipped
    if (-not $SkipTests) {
        Write-Host "üß™ Executando testes das Functions..." -ForegroundColor Yellow
        npm run test
        
        if ($LASTEXITCODE -ne 0 -and -not $Force) {
            Write-Host "‚ùå Testes falharam. Use -Force para continuar" -ForegroundColor Red
            exit 1
        }
    }
    
    # Deploy Functions
    Write-Host "üöÄ Fazendo deploy das Functions..." -ForegroundColor Yellow
    firebase deploy --only functions --project $ProjectId
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Falha no deploy das Functions" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "‚úÖ Functions deployadas com sucesso" -ForegroundColor Green
    Set-Location ..
    
    # Step 2: Configure production environment variables
    Write-Host "`n‚öôÔ∏è Passo 2: Configurando vari√°veis de ambiente" -ForegroundColor Cyan
    Write-Host "=============================================" -ForegroundColor Cyan
    
    # Set Firebase Functions config
    Write-Host "üîß Configurando vari√°veis das Functions..." -ForegroundColor Yellow
    
    $configCommands = @(
        "firebase functions:config:set email.service_enabled=true --project $ProjectId",
        "firebase functions:config:set email.from=noreply@curva-mestra.firebaseapp.com --project $ProjectId",
        "firebase functions:config:set monitoring.performance=true --project $ProjectId",
        "firebase functions:config:set monitoring.error_reporting=true --project $ProjectId",
        "firebase functions:config:set monitoring.analytics=true --project $ProjectId",
        "firebase functions:config:set security.cors_origins=https://curva-mestra.web.app,https://curva-mestra.firebaseapp.com --project $ProjectId",
        "firebase functions:config:set backup.enabled=true --project $ProjectId",
        "firebase functions:config:set backup.schedule='0 2 * * *' --project $ProjectId",
        "firebase functions:config:set backup.retention_days=30 --project $ProjectId"
    )
    
    foreach ($cmd in $configCommands) {
        Write-Host "Executando: $cmd" -ForegroundColor Gray
        Invoke-Expression $cmd
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è Aviso: Falha ao configurar: $cmd" -ForegroundColor Yellow
        }
    }
    
    Write-Host "‚úÖ Configura√ß√£o de ambiente conclu√≠da" -ForegroundColor Green
    
    # Step 3: Deploy Frontend to Firebase Hosting
    Write-Host "`nüåê Passo 3: Deploy do Frontend (Firebase Hosting)" -ForegroundColor Cyan
    Write-Host "================================================" -ForegroundColor Cyan
    
    Set-Location frontend
    
    if (-not $SkipBuild) {
        # Install dependencies
        Write-Host "üì¶ Instalando depend√™ncias do frontend..." -ForegroundColor Yellow
        npm ci
        
        # Build frontend for production
        Write-Host "üèóÔ∏è Construindo frontend para produ√ß√£o..." -ForegroundColor Yellow
        npm run build:production
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Falha no build do frontend" -ForegroundColor Red
            exit 1
        }
        
        # Verify build output
        if (-not (Test-Path "dist/index.html")) {
            Write-Host "‚ùå Build n√£o gerou arquivos esperados" -ForegroundColor Red
            exit 1
        }
    }
    
    Set-Location ..
    
    # Deploy to Firebase Hosting
    Write-Host "üöÄ Fazendo deploy para Firebase Hosting..." -ForegroundColor Yellow
    firebase deploy --only hosting --project $ProjectId
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Falha no deploy do Hosting" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "‚úÖ Frontend deployado com sucesso" -ForegroundColor Green
    
    # Step 4: Configure Firestore Security Rules and Indexes
    Write-Host "`nüîí Passo 4: Deploy das regras de seguran√ßa e √≠ndices" -ForegroundColor Cyan
    Write-Host "==================================================" -ForegroundColor Cyan
    
    Write-Host "üîß Fazendo deploy das regras do Firestore..." -ForegroundColor Yellow
    firebase deploy --only firestore:rules --project $ProjectId
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Falha no deploy das regras do Firestore" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "üìä Fazendo deploy dos √≠ndices do Firestore..." -ForegroundColor Yellow
    firebase deploy --only firestore:indexes --project $ProjectId
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Falha no deploy dos √≠ndices do Firestore" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "‚úÖ Regras e √≠ndices deployados com sucesso" -ForegroundColor Green
    
    # Step 5: Setup monitoring and alerts
    Write-Host "`nüìä Passo 5: Configurando monitoramento e alertas" -ForegroundColor Cyan
    Write-Host "=============================================" -ForegroundColor Cyan
    
    Write-Host "üîß Executando configura√ß√£o de monitoramento..." -ForegroundColor Yellow
    
    # Run monitoring setup script
    try {
        & "$ProjectRoot\scripts\setup-monitoring.ps1" -ProjectId $ProjectId -SkipEmailAlerts
        Write-Host "‚úÖ Monitoramento configurado com sucesso" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è Erro na configura√ß√£o de monitoramento: $($_.Exception.Message)" -ForegroundColor Yellow
        Write-Host "Continuando com o deploy..." -ForegroundColor Yellow
    }
    
    Write-Host "üìä Configurando alertas adicionais no Firebase Console:" -ForegroundColor Yellow
    Write-Host "   - Performance Monitoring: https://console.firebase.google.com/project/$ProjectId/performance" -ForegroundColor Gray
    Write-Host "   - Crashlytics: https://console.firebase.google.com/project/$ProjectId/crashlytics" -ForegroundColor Gray
    Write-Host "   - Analytics: https://console.firebase.google.com/project/$ProjectId/analytics" -ForegroundColor Gray
    
    # Step 6: Final validation
    Write-Host "`n‚úÖ Passo 6: Valida√ß√£o final" -ForegroundColor Cyan
    Write-Host "===========================" -ForegroundColor Cyan
    
    Write-Host "üîç Executando valida√ß√£o completa..." -ForegroundColor Yellow
    
    # Run validation script
    try {
        & "$ProjectRoot\scripts\validate-production.ps1" -ProjectId $ProjectId -FrontendUrl $FrontendUrl -FunctionsUrl $FunctionsUrl
        Write-Host "‚úÖ Valida√ß√£o conclu√≠da com sucesso" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è Alguns testes de valida√ß√£o falharam" -ForegroundColor Yellow
        Write-Host "Verifique os logs acima para detalhes" -ForegroundColor Yellow
    }
    
    # Display final configuration
    Write-Host "`nüìã CONFIGURA√á√ÉO FINAL DE PRODU√á√ÉO" -ForegroundColor Cyan
    Write-Host "=================================" -ForegroundColor Cyan
    Write-Host "üåê Frontend URL: $FrontendUrl" -ForegroundColor White
    Write-Host "‚ö° Functions URL: $FunctionsUrl" -ForegroundColor White
    Write-Host "üóÑÔ∏è Firestore: Configurado com regras de seguran√ßa" -ForegroundColor White
    Write-Host "üîê Authentication: Firebase Auth ativo" -ForegroundColor White
    Write-Host "üìä Monitoring: Performance, Analytics, Error Reporting" -ForegroundColor White
    Write-Host "üíæ Backup: Configurado para execu√ß√£o di√°ria √†s 2h" -ForegroundColor White
    
    Write-Host "`nüéâ DEPLOY DE PRODU√á√ÉO CONCLU√çDO COM SUCESSO!" -ForegroundColor Green
    Write-Host "============================================" -ForegroundColor Green
    
    # Optional: Open in browser
    $openBrowser = Read-Host "`nAbrir aplica√ß√£o no navegador? (y/N)"
    if ($openBrowser -eq "y" -or $openBrowser -eq "Y") {
        Start-Process $FrontendUrl
    }
    
} catch {
    Write-Host "‚ùå Erro durante o deploy: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "Stack trace: $($_.Exception.StackTrace)" -ForegroundColor Red
    exit 1
}

Write-Host "`nüìù Pr√≥ximos passos:" -ForegroundColor Cyan
Write-Host "- Configurar alertas no Firebase Console" -ForegroundColor White
Write-Host "- Configurar dom√≠nio customizado (se necess√°rio)" -ForegroundColor White
Write-Host "- Executar testes de integra√ß√£o em produ√ß√£o" -ForegroundColor White
Write-Host "- Configurar monitoramento de custos" -ForegroundColor White