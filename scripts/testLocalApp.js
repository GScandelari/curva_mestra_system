#!/usr/bin/env node

/**
 * Test Local Application
 * 
 * This script tests the local application to identify SYS_001 errors
 */

const puppeteer = require('puppeteer');

async function testLocalApp() {
  console.log('üîç Testando aplica√ß√£o local para identificar erro SYS_001...\n');

  let browser;
  try {
    // Launch browser
    browser = await puppeteer.launch({
      headless: false, // Set to true for headless mode
      devtools: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();

    // Listen for console messages
    page.on('console', msg => {
      const type = msg.type();
      const text = msg.text();
      
      if (type === 'error') {
        console.log('‚ùå Console Error:', text);
      } else if (text.includes('SYS_001')) {
        console.log('üö® SYS_001 Error Found:', text);
      }
    });

    // Listen for network failures
    page.on('requestfailed', request => {
      console.log('üåê Network Error:', request.url(), request.failure().errorText);
    });

    // Navigate to local app
    console.log('üì± Navegando para http://localhost:3000...');
    await page.goto('http://localhost:3000', { 
      waitUntil: 'networkidle2',
      timeout: 30000 
    });

    // Wait for page to load
    await page.waitForTimeout(3000);

    // Check for error messages on page
    const errorElements = await page.$$eval('[class*="error"], [class*="Error"]', elements => 
      elements.map(el => el.textContent)
    );

    if (errorElements.length > 0) {
      console.log('üîç Erros encontrados na p√°gina:');
      errorElements.forEach(error => {
        if (error.includes('SYS_001')) {
          console.log('üö® SYS_001:', error);
        } else {
          console.log('‚ö†Ô∏è Erro:', error);
        }
      });
    }

    // Try to interact with the app
    console.log('üîÑ Testando intera√ß√µes b√°sicas...');
    
    // Check if login form exists
    const loginForm = await page.$('form');
    if (loginForm) {
      console.log('‚úÖ Formul√°rio de login encontrado');
    }

    // Check for any SYS_001 in page content
    const pageContent = await page.content();
    if (pageContent.includes('SYS_001')) {
      console.log('üö® SYS_001 encontrado no conte√∫do da p√°gina');
    }

    console.log('‚úÖ Teste conclu√≠do. Verifique os logs acima para erros SYS_001.');

  } catch (error) {
    console.error('‚ùå Erro durante o teste:', error.message);
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

// Check if puppeteer is available
try {
  require('puppeteer');
  testLocalApp();
} catch (error) {
  console.log('‚ö†Ô∏è Puppeteer n√£o est√° instalado. Testando manualmente...\n');
  
  console.log('üîç Para identificar o erro SYS_001:');
  console.log('1. Abra http://localhost:3000 no navegador');
  console.log('2. Abra o Console do Desenvolvedor (F12)');
  console.log('3. Procure por erros que contenham "SYS_001"');
  console.log('4. Verifique a aba Network para falhas de requisi√ß√£o');
  console.log('5. Tente fazer login ou navegar pela aplica√ß√£o');
  console.log('\nüìã Poss√≠veis causas do SYS_001:');
  console.log('- Erro de conex√£o com Firebase');
  console.log('- Problema de autentica√ß√£o');
  console.log('- Falha na inicializa√ß√£o do app');
  console.log('- Erro de configura√ß√£o');
}