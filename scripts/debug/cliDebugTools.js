#!/usr/bin/env node

/**
 * Utilit√°rios de Debug para Linha de Comando
 * Ferramentas CLI para diagn√≥stico e debug do sistema
 */

const fs = require('fs');
const path = require('path');
const { execSync, spawn } = require('child_process');
const readline = require('readline');

class CLIDebugTools {
  constructor() {
    this.projectRoot = process.cwd();
    this.logDir = path.join(this.projectRoot, 'scripts/logs');
    this.ensureLogDirectory();
  }

  ensureLogDirectory() {
    if (!fs.existsSync(this.logDir)) {
      fs.mkdirSync(this.logDir, { recursive: true });
    }
  }

  // Utilit√°rio para executar comandos com timeout
  execWithTimeout(command, timeout = 10000) {
    try {
      return execSync(command, { 
        timeout, 
        encoding: 'utf8',
        stdio: 'pipe'
      });
    } catch (error) {
      return `ERROR: ${error.message}`;
    }
  }

  // Monitor de logs em tempo real
  watchLogs(logFile = 'backend/logs/app.log') {
    console.log(`üìä Monitorando logs: ${logFile}`);
    console.log('Pressione Ctrl+C para parar\n');

    if (!fs.existsSync(logFile)) {
      console.log(`‚ùå Arquivo de log n√£o encontrado: ${logFile}`);
      return;
    }

    const tail = spawn('tail', ['-f', logFile]);
    
    tail.stdout.on('data', (data) => {
      const lines = data.toString().split('\n');
      lines.forEach(line => {
        if (line.trim()) {
          this.formatLogLine(line);
        }
      });
    });

    tail.stderr.on('data', (data) => {
      console.error(`Erro no tail: ${data}`);
    });

    process.on('SIGINT', () => {
      tail.kill();
      console.log('\nüìä Monitoramento de logs interrompido');
      process.exit(0);
    });
  }

  formatLogLine(line) {
    const timestamp = new Date().toLocaleTimeString();
    
    if (line.includes('ERROR') || line.includes('CRITICAL')) {
      console.log(`üî¥ [${timestamp}] ${line}`);
    } else if (line.includes('WARN')) {
      console.log(`üü° [${timestamp}] ${line}`);
    } else if (line.includes('INFO')) {
      console.log(`üîµ [${timestamp}] ${line}`);
    } else {
      console.log(`‚ö™ [${timestamp}] ${line}`);
    }
  }

  // An√°lise de performance de processos
  analyzeProcessPerformance() {
    console.log('üìà Analisando performance de processos Node.js...\n');

    try {
      // Processos Node.js ativos
      const processes = this.execWithTimeout('ps aux | grep node | grep -v grep');
      console.log('üîç Processos Node.js ativos:');
      console.log(processes);

      // Uso de mem√≥ria
      const memory = this.execWithTimeout('free -h');
      console.log('üíæ Uso de mem√≥ria:');
      console.log(memory);

      // Uso de CPU
      const cpu = this.execWithTimeout('top -bn1 | grep "Cpu(s)"');
      console.log('‚ö° Uso de CPU:');
      console.log(cpu);

      // Espa√ßo em disco
      const disk = this.execWithTimeout('df -h');
      console.log('üíø Espa√ßo em disco:');
      console.log(disk);

    } catch (error) {
      console.error('‚ùå Erro ao analisar performance:', error.message);
    }
  }

  // Monitor de rede
  monitorNetwork() {
    console.log('üåê Monitorando conex√µes de rede...\n');

    try {
      // Conex√µes ativas
      const connections = this.execWithTimeout('netstat -tuln | grep LISTEN');
      console.log('üîó Portas em escuta:');
      console.log(connections);

      // Teste de conectividade
      const hosts = [
        'google.com',
        'firebase.googleapis.com',
        'firestore.googleapis.com'
      ];

      console.log('üèì Teste de conectividade:');
      hosts.forEach(host => {
        try {
          this.execWithTimeout(`ping -c 1 ${host}`, 5000);
          console.log(`‚úÖ ${host}: OK`);
        } catch (error) {
          console.log(`‚ùå ${host}: FALHA`);
        }
      });

    } catch (error) {
      console.error('‚ùå Erro ao monitorar rede:', error.message);
    }
  }

  // An√°lise de depend√™ncias
  analyzeDependencies() {
    console.log('üì¶ Analisando depend√™ncias...\n');

    const packageFiles = [
      'package.json',
      'frontend/package.json',
      'backend/package.json',
      'functions/package.json'
    ];

    packageFiles.forEach(file => {
      if (fs.existsSync(file)) {
        console.log(`üìÑ Analisando ${file}:`);
        
        try {
          const packageJson = JSON.parse(fs.readFileSync(file, 'utf8'));
          
          // Depend√™ncias principais
          const deps = Object.keys(packageJson.dependencies || {});
          console.log(`  üìö Depend√™ncias (${deps.length}):`, deps.slice(0, 5).join(', '));
          
          // Depend√™ncias de desenvolvimento
          const devDeps = Object.keys(packageJson.devDependencies || {});
          console.log(`  üõ†Ô∏è Dev Dependencies (${devDeps.length}):`, devDeps.slice(0, 5).join(', '));
          
          // Verificar vulnerabilidades
          try {
            const audit = this.execWithTimeout(`npm audit --json`, 15000);
            const auditData = JSON.parse(audit);
            console.log(`  üîí Vulnerabilidades: ${auditData.metadata?.vulnerabilities?.total || 0}`);
          } catch (auditError) {
            console.log('  üîí N√£o foi poss√≠vel verificar vulnerabilidades');
          }
          
        } catch (error) {
          console.log(`  ‚ùå Erro ao analisar ${file}:`, error.message);
        }
        
        console.log('');
      }
    });
  }

  // Verifica√ß√£o de sa√∫de do Firebase
  checkFirebaseHealth() {
    console.log('üî• Verificando sa√∫de do Firebase...\n');

    try {
      // Verificar CLI do Firebase
      const firebaseVersion = this.execWithTimeout('firebase --version');
      console.log('üîß Firebase CLI:', firebaseVersion.trim());

      // Verificar projeto ativo
      const project = this.execWithTimeout('firebase use');
      console.log('üìã Projeto ativo:', project.trim());

      // Verificar status dos servi√ßos
      console.log('üîç Testando servi√ßos Firebase...');
      
      // Teste b√°sico de conectividade
      const services = [
        'firestore.googleapis.com',
        'firebase.googleapis.com',
        'identitytoolkit.googleapis.com'
      ];

      services.forEach(service => {
        try {
          this.execWithTimeout(`curl -s -o /dev/null -w "%{http_code}" https://${service}`, 5000);
          console.log(`‚úÖ ${service}: Acess√≠vel`);
        } catch (error) {
          console.log(`‚ùå ${service}: Inacess√≠vel`);
        }
      });

    } catch (error) {
      console.error('‚ùå Erro ao verificar Firebase:', error.message);
    }
  }

  // Limpeza de cache e arquivos tempor√°rios
  cleanupSystem() {
    console.log('üßπ Limpando sistema...\n');

    const cleanupTasks = [
      {
        name: 'Cache npm',
        command: 'npm cache clean --force',
        path: null
      },
      {
        name: 'node_modules (root)',
        command: null,
        path: 'node_modules'
      },
      {
        name: 'node_modules (frontend)',
        command: null,
        path: 'frontend/node_modules'
      },
      {
        name: 'node_modules (backend)',
        command: null,
        path: 'backend/node_modules'
      },
      {
        name: 'Logs antigos',
        command: null,
        path: 'scripts/logs'
      },
      {
        name: 'Build artifacts',
        command: null,
        path: 'frontend/dist'
      }
    ];

    cleanupTasks.forEach(task => {
      try {
        if (task.command) {
          console.log(`üîÑ ${task.name}...`);
          this.execWithTimeout(task.command);
          console.log(`‚úÖ ${task.name}: Limpo`);
        } else if (task.path && fs.existsSync(task.path)) {
          console.log(`üîÑ ${task.name}...`);
          fs.rmSync(task.path, { recursive: true, force: true });
          console.log(`‚úÖ ${task.name}: Removido`);
        } else {
          console.log(`‚ö™ ${task.name}: N√£o encontrado`);
        }
      } catch (error) {
        console.log(`‚ùå ${task.name}: Erro - ${error.message}`);
      }
    });

    console.log('\nüéâ Limpeza conclu√≠da!');
  }

  // Menu interativo
  async showInteractiveMenu() {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    const menu = `
üîß FERRAMENTAS DE DEBUG CLI

1. üìä Monitorar logs em tempo real
2. üìà Analisar performance de processos
3. üåê Monitorar rede
4. üì¶ Analisar depend√™ncias
5. üî• Verificar sa√∫de do Firebase
6. üßπ Limpeza do sistema
7. üîç Diagn√≥stico completo
8. ‚ùå Sair

Escolha uma op√ß√£o (1-8): `;

    const choice = await new Promise(resolve => {
      rl.question(menu, resolve);
    });

    rl.close();

    switch (choice.trim()) {
      case '1':
        this.watchLogs();
        break;
      case '2':
        this.analyzeProcessPerformance();
        break;
      case '3':
        this.monitorNetwork();
        break;
      case '4':
        this.analyzeDependencies();
        break;
      case '5':
        this.checkFirebaseHealth();
        break;
      case '6':
        this.cleanupSystem();
        break;
      case '7':
        this.runFullDiagnostic();
        break;
      case '8':
        console.log('üëã Saindo...');
        process.exit(0);
        break;
      default:
        console.log('‚ùå Op√ß√£o inv√°lida');
        this.showInteractiveMenu();
    }
  }

  // Diagn√≥stico completo
  runFullDiagnostic() {
    console.log('üîç Executando diagn√≥stico completo...\n');
    
    this.analyzeProcessPerformance();
    console.log('\n' + '='.repeat(50) + '\n');
    
    this.monitorNetwork();
    console.log('\n' + '='.repeat(50) + '\n');
    
    this.analyzeDependencies();
    console.log('\n' + '='.repeat(50) + '\n');
    
    this.checkFirebaseHealth();
    console.log('\n' + '='.repeat(50) + '\n');
    
    console.log('‚úÖ Diagn√≥stico completo finalizado!');
  }
}

// CLI Interface
if (require.main === module) {
  const tools = new CLIDebugTools();
  const command = process.argv[2];

  switch (command) {
    case 'logs':
      tools.watchLogs(process.argv[3]);
      break;
    case 'performance':
      tools.analyzeProcessPerformance();
      break;
    case 'network':
      tools.monitorNetwork();
      break;
    case 'deps':
      tools.analyzeDependencies();
      break;
    case 'firebase':
      tools.checkFirebaseHealth();
      break;
    case 'cleanup':
      tools.cleanupSystem();
      break;
    case 'diagnostic':
      tools.runFullDiagnostic();
      break;
    case 'menu':
    default:
      tools.showInteractiveMenu();
      break;
  }
}

module.exports = CLIDebugTools;