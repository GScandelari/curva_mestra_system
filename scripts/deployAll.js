#!/usr/bin/env node

/**
 * Deploy All Changes
 * 
 * This script automatically commits changes to Git and deploys to Firebase
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('üöÄ Iniciando deploy completo...\n');

// Function to execute command and log output
function executeCommand(command, options = {}) {
  try {
    console.log(`üìã Executando: ${command}`);
    const output = execSync(command, { 
      encoding: 'utf8', 
      stdio: 'inherit',
      ...options 
    });
    return { success: true, output };
  } catch (error) {
    console.error(`‚ùå Erro ao executar: ${command}`);
    console.error(error.message);
    return { success: false, error: error.message };
  }
}

// Check if there are changes to commit
function hasChangesToCommit() {
  try {
    const status = execSync('git status --porcelain', { encoding: 'utf8' });
    return status.trim().length > 0;
  } catch (error) {
    console.error('‚ùå Erro ao verificar status do Git:', error.message);
    return false;
  }
}

// Get commit message from user or use default
function getCommitMessage() {
  const args = process.argv.slice(2);
  const messageIndex = args.indexOf('-m');
  
  if (messageIndex !== -1 && args[messageIndex + 1]) {
    return args[messageIndex + 1];
  }
  
  // Default commit message with timestamp
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  return `chore: Deploy autom√°tico - ${timestamp}`;
}

// Main deployment function
async function deployAll() {
  const startTime = new Date();
  
  try {
    // Step 1: Check for changes
    console.log('1Ô∏è‚É£ Verificando altera√ß√µes...');
    if (!hasChangesToCommit()) {
      console.log('‚ÑπÔ∏è Nenhuma altera√ß√£o encontrada para commit');
    } else {
      // Step 2: Add all changes
      console.log('2Ô∏è‚É£ Adicionando altera√ß√µes ao Git...');
      const addResult = executeCommand('git add .');
      if (!addResult.success) {
        throw new Error('Falha ao adicionar arquivos ao Git');
      }

      // Step 3: Commit changes
      console.log('3Ô∏è‚É£ Fazendo commit das altera√ß√µes...');
      const commitMessage = getCommitMessage();
      const commitResult = executeCommand(`git commit -m "${commitMessage}"`);
      if (!commitResult.success) {
        throw new Error('Falha ao fazer commit');
      }

      // Step 4: Push to repository
      console.log('4Ô∏è‚É£ Enviando para reposit√≥rio...');
      const pushResult = executeCommand('git push origin main');
      if (!pushResult.success) {
        throw new Error('Falha ao fazer push');
      }
    }

    // Step 5: Build frontend
    console.log('5Ô∏è‚É£ Fazendo build do frontend...');
    const buildResult = executeCommand('npm run build', { cwd: 'frontend' });
    if (!buildResult.success) {
      throw new Error('Falha no build do frontend');
    }

    // Step 6: Deploy to Firebase
    console.log('6Ô∏è‚É£ Fazendo deploy no Firebase...');
    const deployResult = executeCommand('firebase deploy --only "functions,hosting" --project curva-mestra');
    if (!deployResult.success) {
      throw new Error('Falha no deploy do Firebase');
    }

    // Success
    const endTime = new Date();
    const duration = Math.round((endTime - startTime) / 1000);
    
    console.log('\n‚úÖ Deploy completo realizado com sucesso!');
    console.log(`‚è±Ô∏è Tempo total: ${duration} segundos`);
    console.log('üåê URL da aplica√ß√£o: https://curva-mestra.web.app');
    console.log('üîß Console Firebase: https://console.firebase.google.com/project/curva-mestra/overview');
    
  } catch (error) {
    console.error('\n‚ùå Erro durante o deploy:', error.message);
    process.exit(1);
  }
}

// Show help
function showHelp() {
  console.log(`
üöÄ Deploy All Changes

Uso:
  node scripts/deployAll.js                    # Deploy com mensagem autom√°tica
  node scripts/deployAll.js -m "Sua mensagem" # Deploy com mensagem customizada
  node scripts/deployAll.js --help            # Mostrar esta ajuda

O que este script faz:
1. Verifica se h√° altera√ß√µes no Git
2. Adiciona todas as altera√ß√µes (git add .)
3. Faz commit com mensagem autom√°tica ou customizada
4. Faz push para o reposit√≥rio (git push origin main)
5. Faz build do frontend (npm run build)
6. Faz deploy no Firebase (functions + hosting)

Exemplos:
  node scripts/deployAll.js -m "feat: Nova funcionalidade X"
  node scripts/deployAll.js -m "fix: Corre√ß√£o do bug Y"
  node scripts/deployAll.js -m "docs: Atualiza√ß√£o da documenta√ß√£o"
`);
}

// Check command line arguments
const args = process.argv.slice(2);
if (args.includes('--help') || args.includes('-h')) {
  showHelp();
  process.exit(0);
}

// Run deployment
deployAll();